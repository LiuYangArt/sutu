# GPU-First M2：压感回归与偶发丢笔触，阶段性回退复盘（2026-02-06）

**日期**：2026-02-06  
**状态**：已回退（保留 GPU 提交锁改动，压感实验改动撤销）

## 背景

在 M2 单层 GPU 可绘重构中，为解决“大画布起笔 1px 细线/偶发不出笔”，我们对 WinTab 压力采样与起笔回放策略做了一轮收紧：
- WinTab 优先取“最近非零 pressure”
- `pointerdown` 引入 `currentPoint` 新鲜度兜底
- 起笔回放统一跳过首点

该轮改动上线后，用户反馈：
- 压感整体变得不顺滑，笔触宽度波动异常
- 仍偶发“画不出来”
- 极偶发“笔触消失”

结论：此轮输入侧策略导致回归，且未消除核心正确性问题。

## 现象与影响

1. **输入手感退化（高频）**
- 压感曲线不连续，起笔/行笔过渡不稳定

2. **偶发正确性问题（中频）**
- 部分笔触未落到画布

3. **极偶发提交异常（低频）**
- 预览曾出现但最终未提交（用户体感为“消失”）

影响判断：
- 当前已触发正确性风险，性能优化结果不再可信
- 必须先恢复稳定基线，再推进 GPU 性能阶段

## 根因判断（阶段性）

本轮改动把“设备采样抖动/边界样本”处理做得过于激进，改变了起笔样本分布：
- 把一部分真实低压点当成噪声过滤，导致压感过渡断层
- 在 WinTab 缓冲为空/延迟时，起笔路径存在策略分叉，造成行为不一致
- 输入层与提交层问题被混在一起处理，难以验证单一变更效果

## 本次处置

已回退以下文件的本轮压感实验改动：
- `src/components/Canvas/inputUtils.ts`
- `src/components/Canvas/usePointerHandlers.ts`
- `src/components/Canvas/useStrokeProcessor.ts`
- 删除 `src/components/Canvas/__tests__/inputUtils.test.ts`

保留不回退项：
- `src/components/Canvas/useBrushRenderer.ts` 中已验证有效的 GPU commit finishing lock（用于避免尾随笔触竞态）

## 决策

采用“稳定性优先”路线：
1. 先恢复可预测输入与提交正确性
2. 再进入 5000x5000 性能收敛

不采用“带回归继续做性能”的路线，避免错误基线上做优化导致返工。

## 后续行动（Gate）

进入下一阶段前，必须满足稳定性门禁：
1. 5000x5000 单层连续 100 笔，无丢笔触/消失
2. 无 `GPUValidationError` / device lost
3. 抬笔后无延迟补 dab
4. 压感起笔与行笔连续，无明显 1px 细线伪迹

通过后再执行性能项：
- 减少 CPU 参与链路
- 缩短 commit 路径耗时
- 回填 M2 验收与性能数据

