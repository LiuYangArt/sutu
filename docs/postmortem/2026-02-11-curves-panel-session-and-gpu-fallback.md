# Curves 面板一期复盘（会话隔离、CPU 兜底、GPU 二期恢复）

**日期**: 2026-02-11  
**范围**: Curves 面板（Ctrl+M）  
**状态**: 一期已可用，GPU 曲线预留二期开关

## 背景

一期目标是先完成可用的曲线工作流：单层、选区内生效、实时预览、OK/Cancel 语义、面板内独立交互。  
上线后出现了几类典型问题：视觉参数有变化但图层不变、快捷键冲突、面板尺寸不稳定、曲线显示锯齿、点拖出边界后行为不符合 PS 习惯。

## 主要问题与根因

### 1. 曲线预览/提交不生效（用户可见）

**现象**: 曲线点和 I/O 数值变化，但画布不变，点击 OK 后也不落盘。  
**根因**: GPU 曲线路径仍处于新链路磨合期，预览与提交虽然有实现，但在当前环境下存在链路不稳定；一期未隔离风险直接暴露给用户。

### 2. 面板内编辑与全局历史冲突

**现象**: 在曲线面板里按 `Ctrl+Z/Delete` 会影响外部画布历史或其他全局行为。  
**根因**: 面板编辑状态没有独立历史栈，且键盘事件未在 capture 阶段优先消费。

### 3. 面板高度体验不稳定（过矮或过高）

**现象**: 有时底部按钮被裁切，有时又出现较大空白。  
**根因**: 浮动面板外层使用固定高度，内部内容又存在固定尺寸区域，导致不同阶段只能靠手调高度，无法自动贴合内容。

### 4. 曲线视觉锯齿明显

**现象**: 曲线边缘“折线感”偏重。  
**根因**: 显示路径采用 256 点离散采样直接连线，采样密度偏低。

### 5. 交互细节与 PS 不一致

**现象**: 控制点拖出曲线框后未删除。  
**根因**: 拖拽状态机没有“出框删除”分支。

## 一期修复策略（已落地）

1. **稳定优先**：保留 GPU 曲线代码，但默认关闭 GPU 曲线开关，曲线会话默认走 CPU，确保“预览可见 + OK 生效”。
2. **会话隔离**：曲线面板引入本地 undo/redo 栈，并在 capture 阶段拦截 `Ctrl/Cmd+Z`、`Ctrl/Cmd+Shift+Z`、`Ctrl/Cmd+Y`、`Delete`。
3. **尺寸策略**：曲线图区域固定像素尺寸；面板层支持 `autoHeight`，曲线面板使用内容自适应高度且禁缩放。
4. **显示优化**：曲线路径改为更高密度采样（1024）+ `geometricPrecision` + round line cap/join。
5. **交互补齐**：非端点控制点支持“拖出曲线框后松手删除”。

## 经验沉淀

### 1. 新 GPU 能力上线必须可熔断

所有新 GPU 编辑能力都应默认具备：

- 独立 feature flag（本地可开关）
- CPU 功能等价兜底
- 会话级路径选择（而非全局即时切换）

### 2. 面板型工具必须有“内部历史”

像 Curves 这类参数编辑工具，本质是“临时编辑会话”，其撤销重做应只影响面板内部参数，不能污染画布全局历史。

### 3. 布局问题优先从容器策略解决

单纯调内容区 CSS 不能修复外层固定高度导致的问题。应先确认容器是否固定高度，再决定是否启用自适应。

### 4. 交互对齐要覆盖“边缘手势”

不仅要实现增点/拖拽/删除键，还要覆盖“拖出边界删除”等高频手势，减少专业用户迁移成本。

## GPU 曲线二期可行性结论

**结论**: 完全可做，当前并非“做不了”，而是“为保证一期稳定先关闭默认入口”。  

建议按以下顺序恢复：

1. 加诊断日志：预览 pass、commit tile 数、readback 成功率。  
2. 建最小回归集：无选区/有选区、不同 blend mode、4K 画布、历史回退。  
3. 先灰度开关（开发构建开启），稳定后再默认启用。  
4. 保持 CPU 兜底常驻，不移除。

## 后续行动项

1. 为 GPU 曲线补充端到端回归（重点验证 commit 后 CPU 读回一致性）。  
2. 在 Debug 面板暴露曲线渲染路径状态（gpu/cpu）与失败回退计数。  
3. 若后续支持多层曲线，沿用“会话锁定 + 单条历史提交”的提交语义。

## 补充复盘（RGB + 单通道叠加，2026-02-11）

### 1. 现象

在 RGB 与单通道（R/G/B）同时存在控制点时，单独看 RGB 或单通道都接近 PS，但叠加结果与 PS 偏差明显。

### 2. 根因

CPU 与 GPU 路径都采用了 `RGB -> 单通道` 的映射顺序，而 PS 实测更接近 `单通道 -> RGB`。  
顺序不同会导致叠加曲线在中高斜率区域出现系统性偏差，且 GPU/CPU 会一致“错”。

### 3. 修复

1. CPU 曲线应用顺序改为 `red/green/blue LUT` 先作用，再应用 `rgb LUT`。  
2. GPU `tileCurvesComposite.wgsl` 同步改为同一顺序，避免预览与提交不一致。  
3. 新增叠加场景回归样本：`RGB+Red`、`RGB+Green`、`RGB+Blue` 三组（其中一组保留 ±2 容差）。  

### 4. 新经验

1. 仅验证 `RGB-only` 或 `Channel-only` 不能证明“叠加语义”正确。  
2. 曲线对齐必须有“组合样本集”，至少覆盖：
   - `RGB-only`
   - `R-only / G-only / B-only`
   - `RGB+R / RGB+G / RGB+B`
3. 样本采集需同时记录：
   - 通道名（避免误把 Blue 记成 Green）
   - 控制点 Input/Output
   - Before/After 颜色值（同一像素）
   - Curves 模式（Light 0-255）

## 补充复盘（UI 对齐：精确输入 + 通道叠加可视化，2026-02-11）

### 1. 现象

1. 面板底部 `Input/Output` 只能显示文本，无法像 PS 一样精确输入数值。  
2. 单通道编辑时曲线仍是白色，不利于快速识别当前通道。  
3. 在 `RGB` 视图下，用户看不到已调整的单通道曲线，导致“参数已生效但图上不可见”的理解成本。

### 2. 修复

1. `Input/Output` 改为数字输入框，支持 `Blur/Enter` 提交；输入值按控制点合法范围自动夹取。  
2. 主曲线颜色按通道着色：`Red/Green/Blue` 分别显示红/绿/蓝，`RGB` 保持白色。  
3. `RGB` 视图增加单通道叠加曲线显示，仅在该通道 LUT 非 identity 时展示。  
4. `RGB` 视图下彩色叠加线展示“单通道原始曲线形态”，不随 RGB 曲线变形（与 Photoshop 一致）。

### 3. 新经验

1. 曲线工具“可解释性”不只靠数值正确，还依赖 UI 对曲线来源语义的可视化。  
2. 像素应用顺序与 UI 叠加展示语义是两个维度：  
   - 计算链路应保持 `单通道 -> RGB`  
   - RGB 视图下彩色叠加线应保持各单通道原始曲线形态  
3. 数值输入框要和拖拽规则共用同一套约束（端点锁定、邻点防穿越），避免两套编辑路径产生不一致结果。

## 补充复盘（RGB 视图叠加线形态修正，2026-02-11）

### 1. 现象

当先调整单通道（如 Red）再调整 RGB 时，RGB 视图里的彩色叠加线会跟随 RGB 曲线变形，用户无法看到 Red 通道原始曲线形态。

### 2. 根因

RGB 视图叠加线误用了复合评估（`channel -> rgb`）来绘制路径，导致展示层把“最终像素映射”与“单通道曲线形态显示”混在一起。

### 3. 修复

1. RGB 视图叠加线改为直接绘制 `red/green/blue` 各自 evaluator 的原始路径。  
2. 保持像素计算链路不变：仍按 `单通道 -> RGB` 执行。  
3. 新增回归用例：修改 RGB 曲线后，单通道叠加线 `d` 路径保持不变。

### 4. 新经验

1. “与 PS 一致”需要分别验证“结果一致（像素）”和“展示一致（UI 语义）”。  
2. 曲线面板测试集应单独包含“RGB 修改不会改变彩色叠加线形态”的断言。

## 补充复盘（Fail-Fast 策略，2026-02-11）

### 1. 背景

此前曲线会话在 GPU 提交失败时会自动走 CPU 提交兜底。  
这种“静默降级”虽然提升了短期可用性，但会掩盖真实 GPU 问题，导致研发误判为“功能正常”。

### 2. 改动

1. 曲线桥接协议改为结构化结果（`preview/commit` 都返回 `ok/error/code/stage`）。  
2. GPU 预览失败后进入 `preview halted`，停止继续尝试 GPU 预览，并在面板内显示详细错误。  
3. GPU 提交失败时不再自动 CPU 回退，默认保持图像不变并返回失败。  
4. 仅保留“手动二次确认 CPU 提交”作为应急路径：第一次点击进入确认态，第二次才真正执行 CPU 提交。  
5. 诊断日志统一为 `[CurvesGpuFailFast]`，记录 `sessionId/layerId/stage/code/error`。

### 3. 新经验

1. 对高风险新链路，默认应优先暴露错误而不是掩盖错误。  
2. 自动兜底应仅用于面向普通用户的发布策略，不应干扰研发阶段问题定位。  
3. “Fail-Fast + 手动应急通道”可以兼顾可修复性与可恢复性。
