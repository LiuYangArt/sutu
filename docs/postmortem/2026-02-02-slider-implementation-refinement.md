# Non-Linear Slider Implementation Postmortem

**日期**: 2026-02-02
**作者**: Antigravity
**状态**: 已完成

## 问题背景

用户希望 PaintBoard 的画笔大小和间距滑块能模仿 Photoshop 的非线性行为。具体表现为：

1.  **小数值精细控制**：在 0-100 范围内需要精细调节。
2.  **大数值快速缩放**：超过 100 后范围快速扩大。
3.  **特定分布手感**：100px 位于滑块中间 (50%)，而 250px 位于约 75% 的位置，最大值达到 1000px。

## 根本原因分析

最初的实现采用了简单的“分段线性”（Piecewise Linear）映射：

- 0-50% 映射 1-100 (准确)
- 50-100% 线性映射 100-1000 (不准确)

**问题 1：手感不符**
简单的分段线性会导致 50% 之后数值增长过快，或者分布不符合直觉。用户指出 250px 在 PS 中位于 75% 左右，而线性映射下 250px 仅位于 50% + (150/900)\*50% ≈ 58.3% 的位置。这导致滑块后半段“太挤”，不符合用户习惯。

**问题 2：硬编码限制**
在 UI 层将最大值改为 1000px 后，用户发现实际上限仍卡在 800px。排查发现 `src/stores/tool.ts` 中存在硬编码的 `clampSize` 函数，将最大值限制在 800，这一“隐形墙”导致 UI 与 数据层不一致。

## 解决方案

1.  **引入 幂函数 (Power Curve) 插值**
    为了模拟 PS 的非线性分布，在滑块的后半段（100px - 1000px）引入了指数为 2.5 的幂函数曲线。
    - 公式：`Value = Mid + (Max - Mid) * t^k`
    - 其中 `k=2.5`。
    - 效果：
      - t=0.5 (75% position) -> `100 + 900 * 0.5^2.5` ≈ `100 + 900 * 0.176` ≈ `258px`。
      - 这与用户观察到的“250px 在 75% 处”非常吻合。

2.  **统一状态管理限制**
    修改 `src/stores/tool.ts`，将 `clampSize` 上限提升至 1000px，确保 UI 的输入能被正确接受。

3.  **高精度内部滑块**
    为了解决非线性映射在大数值区间可能导致的“跳跃”问题（即滑块动一点，数值变很大），使用了 0-10000 的内部高分辨率滑块，保证了调节的平滑性。

## 经验总结

1.  **UI 与 数据的一致性**：修改 UI 范围限制时，必须第一时间检查 Store/Reducer 层的验证逻辑，避免“改了面子，忘了里子”。
2.  **模仿物理手感需用数学拟合**：也就是 User Experience (UX) 的“感觉”往往对应具体的数学曲线（如 gamma 矫正、对数、幂函数）。单纯的线性插值很难满足对“手感”的模拟。
3.  **参数化配置的重要性**：将 `sliderScales.ts` 设计为支持 `config` 传入，使得后续调整幂指数（2.5）非常容易，无需重写核心逻辑，这在快速迭代反馈中起到了关键作用。

## 后续行动

- [x] 将新逻辑应用到 Brush Settings (Size, Spacing)
- [x] 将新逻辑应用到 Toolbar (Size)
- [x] 将新逻辑应用到 Dual Brush (Size, Spacing)
- [ ] (可选) 考虑将 Toolbar 中的手动滑块逻辑封装为可复用的 Hook 或组件，减少代码重复 (将在 Code Simplifier 中进行)。
