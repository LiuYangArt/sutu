# Postmortem: Invisible Selection Border in Rect Selection

**Date**: 2026-01-28
**Author**: Antigravity
**Status**: Resolved
**Impact**: Low (Visual glitch)
**Component**: Selection Tool / Canvas

## Problem Description

When using the rectangular selection tool, the left border of the selection box was invisible during the drag-creation phase. The top, right, and bottom borders were visible, but the closing segment was missing.

## Root Cause Analysis

The rendering logic in `SelectionOverlay.tsx` draws a path based on points provided by `useSelectionStore`.

- For polygonal lasso, the path is naturally continuous.
- For rectangular selection, the path is generated by `createRectPath` in `src/stores/selection.ts`.

The `createRectPath` function was returning an array of 4 points:

1. Top-left
2. Top-right
3. Bottom-right
4. Bottom-left

`SelectionOverlay` loops through these points and calls `ctx.lineTo`. It relies on the path being explicitly closed (returning to the start point) or `ctx.closePath()` being called. However, `SelectionOverlay` is designed to handle open paths (like freehand lasso) and does not automatically close paths. It only closes paths for _existing_ committed selections, not for the _creation preview_ line.

Because the preview path for rect selection contained only 4 points without returning to the start, and the renderer didn't auto-close it, the final segment from Bottom-left back to Top-left was never drawn.

## Solution

Modified `createRectPath` in `src/stores/selection.ts` to return 5 points, where the 5th point is identical to the 1st point.

```typescript
function createRectPath(start: SelectionPoint, end: SelectionPoint): SelectionPoint[] {
  // ... coords calculation ...
  return [
    { x: x1, y: y1 },
    { x: x2, y: y1 },
    { x: x2, y: y2 },
    { x: x1, y: y2 },
    { x: x1, y: y1 }, // Added closing point
  ];
}
```

This forces the renderer to draw the final segment without changing the generic rendering logic in `SelectionOverlay`.

## Lessons Learned

- **Path Consistency**: when systems handle both open (lasso) and closed (rect/poly) shapes, ensure the data structure for closed shapes explicitly includes the closing segment if the renderer is generic.
- **Visual Debugging**: Counting the visible segments (3 out of 4) gave a strong hint that the path wasn't being closed.
