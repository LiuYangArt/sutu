# PSD 背景层修复尝试失败

**日期**: 2026-01-22
**状态**: ❌ 失败 - 已回滚

## 问题描述

Krita 生成的 PSD 文件，背景层显示不完整（只显示部分内容），而其他图层正常。

## 根本原因

**🔴 待调查 - 未确认**

之前的分析认为 `psd` crate 的 `width()` 方法存在 bug（`right - left + 1`），但基于此假设的修复方案完全失败了，说明这个分析很可能是错误的。

需要重新调查：
1. `psd` crate 的行为是否真的有 bug，还是我们对 PSD 格式理解有误
2. Krita 生成的 PSD 与 PaintBoard/Photoshop 生成的 PSD 有什么区别
3. 为什么只有背景层有问题，其他层正常

## 尝试的修复方案

尝试在 `reader.rs` 中实现像素重映射：

1. 计算正确宽度：`correct_width = right - left`
2. 获取错误宽度：`crate_wrong_width = psd_layer.width()`
3. 遍历每个像素，从 crate 错误写入的位置读取，写入到正确的目标位置

## 失败原因

修复逻辑有误。用户反馈"完全搞坏了"，显示结果比之前更糟糕。

可能的问题：
- 对 `psd` crate 内部像素映射机制理解不够深入
- 反向重映射的计算逻辑有误
- 未考虑边缘情况和边界条件

## 经验教训

1. **第三方 crate 的 bug 很难在不修改源码的情况下完美绕过**
2. **复杂的像素重映射逻辑需要更充分的测试**（应该先写单元测试验证逻辑）
3. **应该先确认问题影响的范围**——是否所有 Krita PSD 都有此问题，还是特定文件才有
4. **考虑替代方案**：换用其他 PSD 库、fork 修复 crate、或与上游提 issue

## 后续方向

1. 确认问题是否普遍存在（测试更多 Krita PSD 文件）
2. 与 `psd` crate 上游沟通，报告此 bug
3. 考虑短期接受此限制，或使用其他 PSD 解析方案
4. 如果必须修复，需要编写详细的单元测试验证像素映射逻辑

## 相关文件

- `src-tauri/src/file/psd/reader.rs` - PSD 导入逻辑
- `psd` crate v0.3.5 - 有 bug 的第三方库

## 相关 Commit

- 回滚到: `56d88d9` - "我已修复了 PSD 导入时图层像素数据损坏的问题"
