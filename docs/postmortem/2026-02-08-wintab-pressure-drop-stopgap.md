# WinTab 丢压感止血修复复盘（2026-02-08）

## 背景

用户反馈 WinTab Lite 链路存在“偶发丢压感输入”，而 PointerEvent 链路稳定。
本轮目标是先做止血修复，避免继续出现由输入链路实现缺陷导致的压感断档，同时保持默认后端为 PointerEvent。

## 现象与复现特征

1. WinTab 模式下，连续绘制时偶发出现压感突然不连续或短暂固定。
2. PointerEvent 模式下同设备、同笔速复现概率明显更低。
3. 问题更像“输入样本在桥接链路中被丢弃/错配”，而不是笔刷参数本身异常。

## 根因定位（代码级）

核心根因在后端 WinTab 轮询线程的事件入队逻辑：

- 文件：`src-tauri/src/input/wintab_backend.rs`
- 旧行为：`events.try_lock()` 失败后只短暂重试一次，仍失败时 `new_events` 在分支结束后被丢弃（静默丢事件）。
- 影响：在锁竞争窗口下，真实 WinTab 输入样本可能无法进入后续发射链路，前端表现为“偶发丢压感”。

## 本次止血改动

### 1) 后端：锁竞争不再丢事件

- 文件：`src-tauri/src/input/wintab_backend.rs`
- 改动：

1. 保留 `try_lock` 快路径（低开销）。
2. `try_lock` 失败时改为阻塞 `lock` 慢路径，确保延迟入队而不是丢弃。
3. 增加明确日志：
   - 竞争发生：`delaying enqueue`
   - 延迟入队完成：`delayed enqueue completed`
   - 锁污染恢复：`lock poisoned, recovering`

### 2) 前端：补齐“起笔兜底”诊断计数

- 文件：`src/components/Canvas/usePointerHandlers.ts`
- 改动：

1. WinTab `pointerdown` 无 fresh buffered sample 的兜底路径，新增
   `window.__strokeDiagnostics?.onStartPressureFallback()`。
2. 仅补诊断，不改变现有压感融合策略。

## 为什么不是 wintab_lite 组件本体问题

`wintab_lite` 在当前项目中主要承担 WinTab FFI 结构和函数签名映射。
本次确认的问题出在项目自有的“轮询线程 -> 共享队列 -> 发射”桥接逻辑，而非 `wintab_lite` 的 API 定义本身。

## 验证结果与门禁

### 自动检查

1. TypeScript 类型检查通过。
2. 前端单元测试通过。
3. Rust 测试通过。

### 手工门禁（建议）

1. 切到 WinTab，执行 20 笔混合压力手绘（轻压/中压/重压 + 快慢速）。
2. 观察不应出现明显压感断档或卡死为固定值。
3. 检查 `startPressureFallbackCount` 可读且不持续异常增长。
4. 切回 PointerEvent 再绘制 10 笔，确认默认链路无回归。

## 风险评估

1. 修复后在极端锁竞争下可能从“丢样本”转为“短暂排队延迟”。
2. 本次保持最小改动，不改采样率、状态机和压力算法，降低回归面。
3. 若后续观测到明显延迟放大，可进一步升级为无锁单消费者队列架构。

## 全面重构蓝图（本次不落地）

### A. 时间与样本语义统一

1. 统一后端与前端时基，避免跨时基新鲜度判断。
2. 给每个输入样本增加严格递增序号（而非仅靠时间戳）。

### B. 输入桥接架构升级

1. 从共享 `Mutex<Vec<...>>` 迁移到无锁或单消费者队列。
2. 明确“生产者永不丢样本、消费者可观测背压”的策略。
3. 在背压场景中可配置采样降级规则（按序号保留关键点）。

### C. WinTab / Windows Ink 双栈策略

1. 默认 PointerEvent（稳定优先）。
2. WinTab 作为可选高性能链路。
3. 在设置页面由用户选择手动进行切换。

### D. 端到端可观测性

1. 指标：采样输入数、入队数、出队数、延迟分位、丢样本数。
2. 增加诊断导出：复现场景、后端日志摘要、关键计数曲线。
3. 把门禁固化到回归流程，避免输入层回归再次进入主干。

## 结论

本次修复属于“止血优先”的正确范围：
先消除确定性的静默丢事件缺陷，恢复 WinTab 基本稳定性；
同时保留 PointerEvent 默认基线，并沉淀了后续全面重构所需的架构方向和验收标准。
