# Krita 压感全链路重构门禁规范（双重严格）

## 1. 目的

本规范用于定义“与 Krita 一致”的统一验收口径。  
判定采用双重阻塞门禁：

1. 阶段门禁（中间计算过程）
2. 最终门禁（最终画面结果）

任一失败即整体失败。

---

## 2. 适用范围

1. 适用于压感全链路重构后的回归验收。
2. 默认不依赖 Krita 源码改动。
3. 默认输入文件：
   - `C:\Users\LiuYang\AppData\Roaming\com.sutu\debug-data\debug-stroke-capture.json`

---

## 3. 统一输入与执行前置条件

1. 使用固定输入文件，不允许临时替换。
2. 使用固定画布参数与固定笔刷参数。
3. 使用固定导出 schema 与固定字段命名。
4. 运行环境必须记录版本信息：
   - Sutu 版本/commit
   - Krita 版本
   - OS 与设备信息

---

## 4. 产物 Schema（逻辑层）

一次 gate 运行应产出至少三类结果：

1. `stage_metrics`：阶段门禁指标
2. `final_metrics`：最终门禁指标
3. `fast_windows_metrics`：高速窗口统计指标

并包含：

1. `run_meta`：版本与环境信息
2. `pass_fail`：总结果与分项结果
3. `failure_reasons`：失败原因列表

---

## 5. 阶段门禁定义（必须全过）

固定阶段：

1. 输入样本标准化
2. 全局压感曲线映射
3. 速度估计
4. 采样触发与 carry
5. 线性插值（mix）
6. 动态传感器映射

每阶段至少包含以下指标：

1. 主指标 MAE
2. 主指标 P95
3. 边界样本错误数
4. 缺失/额外样本数

阶段失败条件（任一成立即失败）：

1. MAE 超阈值
2. P95 超阈值
3. 边界样本错误数 > 0
4. 缺失/额外样本数 > 0

---

## 6. 最终门禁定义（必须全过）

固定最终指标：

1. 宽度曲线差异（width profile）
2. 尾段衰减差异（tail decay）
3. 像素差异（全图 + ROI）

最终失败条件（任一成立即失败）：

1. 任一最终指标超阈值
2. ROI 指标通过但全图指标失败
3. 全图指标通过但尾段衰减失败

---

## 7. 高速高样本门禁（必须全过）

目的：防止快速划动场景出现“偶然通过”。

规则：

1. 从同一输入中提取高速窗口（按速度分位）。
2. 采用窗口统计，不采用单点判定。
3. 必须满足最小窗口数量。

失败条件：

1. 窗口数小于最小门槛。
2. 任一高速统计指标超阈值。

---

## 8. 默认阈值策略

默认阈值来源：

1. 历史冻结基线
2. 固定校准流程（多轮统计后固化）

阈值治理规则：

1. 阈值文件必须版本化。
2. 阈值调整必须附带“旧值/新值/原因/影响范围”。
3. 不允许在失败后临时放宽阈值直接过门禁。

---

## 9. 判定输出格式

总结果字段建议：

1. `overall`: `pass | fail`
2. `stage_gate`: `pass | fail`
3. `final_gate`: `pass | fail`
4. `fast_gate`: `pass | fail`
5. `blocking_failures`: 字符串数组

判定规则：

1. `stage_gate=pass` 且 `final_gate=pass` 且 `fast_gate=pass` 才能 `overall=pass`。

---

## 10. 基线资产策略（不改 Krita 源码）

1. 使用冻结 Krita 基线资产作为参考输出。
2. 日常回归使用同输入自动回放并对比冻结资产。
3. 仅在基线升级窗口更新冻结资产。
4. 基线升级必须经过完整回归并留存审计记录。

---

## 11. 失败分级与处理

1. P0 失败：阶段门禁失败或高速门禁失败。
2. P1 失败：仅最终全图像素指标轻微超线但阶段稳定。
3. P2 失败：非关键统计告警（不影响阻塞门禁）。

处理顺序：

1. 先修阶段一致性，再修最终画面一致性。
2. 高速门禁失败优先于普通场景失败处理。

---

## 12. 变更管理

当出现以下变更时，必须重新执行完整门禁：

1. 压感映射公式变更
2. 采样触发策略变更
3. 插值策略变更
4. 动态传感器映射变更
5. 关键数值类型/精度策略变更

