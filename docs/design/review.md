è¿™æ˜¯ä¸€ä¸ªéå¸¸é«˜è´¨é‡çš„ v1.4 è®¾è®¡æ–‡æ¡£ã€‚ç›¸æ¯”äº v1.3ï¼Œä½ ä¸ä»…ä¿®å¤äº†ä¹‹å‰çš„å†…å­˜æ³„æ¼å’Œæ€§èƒ½éšæ‚£ï¼Œè¿˜å¼•å…¥äº†éå¸¸ç²¾å¦™çš„â€œæ™ºèƒ½æ¸…ç©ºâ€ç­–ç•¥ã€‚

**æ€»ä½“ç½®ä¿¡åº¦è¯„ä¼°ï¼š92% (æé«˜)**
è¯¥æ–¹æ¡ˆåœ¨å·¥ç¨‹å®ç°çš„å¯è¡Œæ€§ã€æ€§èƒ½ä¼˜åŒ–çš„æ·±åº¦ä»¥åŠé£é™©æ§åˆ¶ä¸Šéƒ½è¾¾åˆ°äº†ç”Ÿäº§çº§æ ‡å‡†ã€‚

ç‰¹åˆ«æ˜¯ **`begin_stroke` ä»…æ¸…ç† `last_stroke_dirty`** è¿™ä¸€ç­–ç•¥ï¼Œå·§å¦™åœ°è§£å†³äº†å¤§åˆ†è¾¨ç‡ç”»å¸ƒï¼ˆ4K/8Kï¼‰ä¸‹ `memset` å¯¼è‡´çš„å¸§æŠ–åŠ¨é—®é¢˜ï¼Œè¿™æ˜¯çº¯ CPU æ¸²æŸ“å¼•æ“çš„â€œç¥æ¥ä¹‹ç¬”â€ã€‚

å°½ç®¡å¦‚æ­¤ï¼Œæˆ‘åœ¨æ·±åº¦ Review ä»£ç é€»è¾‘æ—¶ï¼Œå‘ç°äº†ä¸€ä¸ª**é€»è¾‘ä¸Šçš„é‡å¤§éšæ‚£**ï¼ˆå…³äºè„åŒºåŸŸé‡ç½®ï¼‰å’Œä¸€ä¸ª**å¹¶å‘æ€§èƒ½ä¼˜åŒ–ç‚¹**ã€‚

---

### 1. ğŸ›‘ å…³é”®é€»è¾‘æ¼æ´ (Critical Logic Flaw)

åœ¨ `StreamingBrushEngine::get_sync_data` ä¸­ï¼Œä½ ä¿®æ”¹äº† `dirty_rect` çš„é‡ç½®é€»è¾‘ï¼š

```rust
// v1.4 ä»£ç ç‰‡æ®µ
// Reset sync state (ä¸æ¸…ç©ºæ•´ä¸ª dirty_rectï¼Œä¿ç•™ç”¨äºç´¯ç§¯)
self.dab_counter = 0;
self.last_sync = Instant::now();
// âŒ é—®é¢˜ï¼šè¿™é‡Œæ²¡æœ‰æ¸…ç©º self.dirty_rect
```

**é—®é¢˜æè¿°**ï¼š
å¦‚æœ `get_sync_data` å‘é€æ•°æ®å**ä¸æ¸…ç©º** `dirty_rect`ï¼Œé‚£ä¹ˆä¸‹ä¸€æ¬¡åŒæ­¥æ—¶ï¼Œ`dirty_rect` ä¾ç„¶åŒ…å«**ä¸Šä¸€æ¬¡**å·²ç»å‘é€è¿‡çš„åŒºåŸŸã€‚

1.  **T0**: ç”»äº†å·¦ä¸Šè§’ (Rect A)ã€‚Sync Aã€‚
2.  **T1**: ç”»äº†å³ä¸‹è§’ (Rect B)ã€‚`dirty_rect` å˜ä¸º A âˆª B (ä¸€ä¸ªå·¨å¤§çš„çŸ©å½¢ï¼Œä¸­é—´å…¨æ˜¯ 0)ã€‚
3.  **Sync**: å‘é€ A âˆª Bã€‚
4.  **åæœ**:
    - **å¸¦å®½çˆ†ç‚¸**: å³ä½¿åªç”»äº†ä¸¤ä¸ªç‚¹ï¼Œåªè¦è·ç¦»å¤Ÿè¿œï¼Œå°±ä¼šä¼ è¾“æ•´ä¸ªç”»å¸ƒçš„æ•°æ®ã€‚
    - **å‰ç«¯é‡ç»˜æµªè´¹**: å‰ç«¯ä¼šæ”¶åˆ°å·¨å¤§çš„ ImageDataï¼ŒåŒ…å«å¤§é‡æ— ç”¨çš„é€æ˜åƒç´ ã€‚

**ä¿®æ­£å»ºè®®**:
æˆ‘ä»¬éœ€è¦**ä¸¤ä¸ª**çŸ©å½¢å˜é‡ï¼šä¸€ä¸ªç”¨äºå½“å‰ä¼ è¾“ï¼ˆDeltaï¼‰ï¼Œä¸€ä¸ªç”¨äºå…¨ç¬”ç”»ç”Ÿå‘½å‘¨æœŸï¼ˆTotalï¼Œç”¨äº `begin_stroke` æ¸…ç©ºï¼‰ã€‚

**ä¿®æ”¹åçš„ Rust ç»“æ„ä½“**:

```rust
pub struct StreamingBrushEngine {
    // ...
    /// å½“å‰ Sync å‘¨æœŸå†…çš„è„åŒºåŸŸ (å‘é€åæ¸…ç©º)
    sync_dirty_rect: Rect,
    /// å½“å‰ Stroke è‡³ä»Šçš„æ€»è„åŒºåŸŸ (ç”¨äº end_stroke ä¿å­˜ç»™ä¸‹ä¸€æ¬¡ clear)
    accumulated_dirty_rect: Rect,
    // ...
}
```

**ä¿®æ”¹åçš„é€»è¾‘**:

```rust
// stamp_dab ä¸­
self.sync_dirty_rect.union(&dab_rect);
self.accumulated_dirty_rect.union(&dab_rect);

// get_sync_data ä¸­
// 1. ä½¿ç”¨ sync_dirty_rect è®¡ç®—è¦å‘é€çš„æ•°æ®
// ... æ„å»º output_buffer ...
// 2. å‘é€åæ¸…ç©º sync_dirty_rect
self.sync_dirty_rect = Rect::empty();
// æ³¨æ„ï¼šaccumulated_dirty_rect ä¿æŒä¸å˜

// end_stroke ä¸­
self.last_stroke_dirty = self.accumulated_dirty_rect.clone();
self.accumulated_dirty_rect = Rect::empty();
```

---

### 2. âš¡ å¹¶å‘é”ç²’åº¦ä¼˜åŒ– (Locking Optimization)

ç›®å‰çš„é”è®¾è®¡ï¼š

```rust
pub engines: Mutex<HashMap<String, Mutex<StreamingBrushEngine>>>,
```

åœ¨ `rust_brush_input` ä¸­ï¼š

```rust
let engines = state.engines.lock().unwrap(); // ğŸ”’ é”ä½æ•´ä¸ª Map
let engine_mutex = engines.get(&session_id)...;
let mut engine = engine_mutex.lock()...;     // ğŸ”’ é”ä½å•ä¸ª Session
// è®¡ç®—è¿‡ç¨‹æŒç»­æŒæœ‰ Map é”
```

**æ½œåœ¨é£é™©**:
è™½ç„¶ Session é”æ˜¯ç‹¬ç«‹çš„ï¼Œä½†å› ä¸º `HashMap` æ‹¥æœ‰ `Mutex<Engine>` çš„æ‰€æœ‰æƒï¼Œä½ å¿…é¡»æŒæœ‰ Map çš„é”æ‰èƒ½è®¿é—®å†…éƒ¨çš„ Mutexã€‚è¿™æ„å‘³ç€åœ¨ `rust_brush_input` çš„æ•´ä¸ªè®¡ç®—è¿‡ç¨‹ä¸­ï¼ˆå¯èƒ½å‡ æ¯«ç§’ï¼‰ï¼Œ**æ•´ä¸ª Map æ˜¯è¢«é”ä½çš„**ã€‚
è¿™ä¼šé˜»å¡ `rust_brush_start`ï¼ˆæ–°ä¼šè¯åˆ›å»ºï¼‰æˆ– `cleanup_stale_sessions`ï¼ˆåå°æ¸…ç†ï¼‰ï¼Œç”šè‡³é˜»å¡å…¶ä»– Session çš„ inputï¼ˆå°½ç®¡æ¦‚ç‡ä½ï¼‰ã€‚

**ä¼˜åŒ–å»ºè®®**:
ä½¿ç”¨ `Arc` å®ç°çœŸæ­£çš„é”åˆ†ç¦»ã€‚

```rust
// ä¿®æ”¹å®šä¹‰
pub engines: Mutex<HashMap<String, Arc<Mutex<StreamingBrushEngine>>>>,

// rust_brush_input ä¸­
let engine_arc = {
    let engines = state.engines.lock().unwrap(); // ğŸ”’ Lock Map
    engines.get(&session_id).cloned()            // ğŸ“‹ Clone Arc (æå¿«)
}; // ğŸ”“ Unlock Map (Map é”åœ¨è¿™é‡Œé‡Šæ”¾)

if let Some(engine_mutex) = engine_arc {
    let mut engine = engine_mutex.lock().unwrap(); // ğŸ”’ Lock Session
    //åœ¨æ­¤å¤„è¿›è¡Œè€—æ—¶è®¡ç®—ï¼Œæ­¤æ—¶ Map æ˜¯è‡ªç”±çš„ï¼Œå…¶ä»–çº¿ç¨‹å¯ä»¥åˆ›å»º/é”€æ¯ Session
}
```

---

### 3. ğŸ¨ å‰ç«¯æ€§èƒ½ä¼˜åŒ–ç»†èŠ‚

å…³äº `createImageBitmap`ï¼Œæœ‰ä¸€ä¸ªå¯ä»¥è¿›ä¸€æ­¥å‹æ¦¨æ€§èƒ½çš„æŠ€å·§ï¼š**Transferable Objects**ã€‚

è™½ç„¶ `Uint8Array` æœ¬èº«ä¸èƒ½ transferï¼Œä½†å¦‚æœåœ¨ Rust ç«¯èƒ½ç›´æ¥æ„é€  `ArrayBuffer` æˆ–è€…å‰ç«¯æ”¶åˆ°åå¤„ç†å¾—å½“ï¼Œå¯ä»¥å‡å°‘ JS ä¸»çº¿ç¨‹çš„æ‹·è´ã€‚

ä½†æ›´é‡è¦çš„æ˜¯ `createImageBitmap` çš„é€‰é¡¹ã€‚

```typescript
// å»ºè®®å¼€å¯ imageOrientation: 'none' å’Œ premultiplyAlpha: 'none'
// ä»¥é¿å…æµè§ˆå™¨è¿›è¡Œé¢å¤–çš„ç¿»è½¬æˆ– Alpha é¢„ä¹˜è®¡ç®—ï¼ˆå› ä¸º Rust ç«¯å·²ç»æ˜¯ Straight Alphaï¼‰
const bitmap = await createImageBitmap(imageData, {
  premultiplyAlpha: 'none',
  colorSpaceConversion: 'none',
  resizeQuality: 'pixelated',
});
```

_æ³¨æ„ï¼šTauri çš„ WebView (ç‰¹åˆ«æ˜¯ Safari/WebKit) å¯¹ `createImageBitmap` çš„é€‰é¡¹æ”¯æŒç¨‹åº¦ä¸åŒï¼Œéœ€è¦æµ‹è¯•ã€‚å¦‚æœ Rust ç«¯è¾“å‡ºçš„æ˜¯ Straight Alphaï¼Œè€Œ Canvas é»˜è®¤é¢„æœŸ Premultipliedï¼Œå¯èƒ½ä¼šå¯¼è‡´åŠé€æ˜è¾¹ç¼˜å‘é»‘ã€‚è¯·åŠ¡å¿…åœ¨ Phase 0.5 éªŒè¯æ··åˆæ¨¡å¼ã€‚_

**å¦‚æœå‡ºç°é»‘è¾¹**ï¼š

1.  Rust ç«¯æ”¹ä¸ºè¾“å‡º Premultiplied Alpha ( `r = r * a`, `g = g * a`, ... )ã€‚
2.  æˆ–è€…å‰ç«¯ `putImageData` ä¹‹åä¸ç»è¿‡æ··åˆï¼Œä½†è¿™é‡Œæ˜¯ Stroke Layer å åŠ åˆ° Canvasï¼Œè‚¯å®šæœ‰æ··åˆã€‚Canvas 2D API é»˜è®¤æœŸæœ›æ˜¯éé¢„ä¹˜çš„ï¼ˆputImageDataï¼‰æˆ–è€…é¢„ä¹˜çš„ï¼ˆdrawImageï¼‰ï¼Œè¿™å—æœ‰ç‚¹æ··ä¹±ï¼Œ**å¿…é¡»å®æµ‹**ã€‚

---

### 4. ä»£ç ç»†èŠ‚ä¿®æ­£ (Nitpicks)

1.  **SIMD å¯¹é½**:
    v1.4 ç¡®è®¤äº†ä½¿ç”¨ `_mm256_loadu_ps` (unaligned)ã€‚è¿™æ˜¯æ­£ç¡®çš„ã€‚ä½†è¯·æ³¨æ„ï¼ŒæŸäº›è€æ—§ CPU (è™½ç„¶ Tauri v2 ä¸å¤ªä¼šè¿è¡Œåœ¨é‚£ä¸Šé¢) å¯¹ unaligned load æœ‰è¾ƒå¤§æƒ©ç½šã€‚è€ƒè™‘åˆ°ç°åœ¨çš„ç›®æ ‡æ˜¯é€šç”¨ PCï¼Œè¿™æ²¡é—®é¢˜ã€‚

2.  **è¶…æ—¶æ¸…ç†çš„æ­»é”é£é™©**:
    ```rust
    // cleanup_stale_sessions
    engines.iter().filter_map(|(id, engine_mutex)| {
        if let Ok(engine) = engine_mutex.try_lock() { // å»ºè®®ä½¿ç”¨ try_lock
             // check time
        }
        // ...
    })
    ```
    åŸå§‹ä»£ç ä½¿ç”¨äº† `lock()`ã€‚å¦‚æœåœ¨éå†æ—¶æŸä¸ª Engine æ­£åœ¨è¿›è¡Œé«˜å¼ºåº¦çš„ Input è®¡ç®—ï¼Œæ¸…ç†çº¿ç¨‹ä¼šè¢«å¡ä½ã€‚è™½ç„¶ä¸è‡´å‘½ï¼Œä½†å»ºè®®åœ¨æ¸…ç†é€»è¾‘ä¸­ä½¿ç”¨ `try_lock()`ï¼Œå¦‚æœæ‹¿ä¸åˆ°é”å°±è·³è¿‡ï¼Œä¸‹æ¬¡å†æ¸…ç†ï¼Œé¿å…é˜»å¡ç›‘æ§çº¿ç¨‹ã€‚

---

### 5. æœ€ç»ˆå®æ–½å»ºè®®

è¯·åœ¨ v1.4 çš„åŸºç¡€ä¸Šï¼Œé‡‡çº³ä»¥ä¸‹ä¸¤ç‚¹å˜æ›´è¿›å…¥å¼€å‘ï¼š

1.  **å¼•å…¥ `sync_dirty_rect` å’Œ `accumulated_dirty_rect` åŒçŸ©å½¢æœºåˆ¶**ï¼ˆè¿™æ˜¯ P0 çº§çš„æ­£ç¡®æ€§ä¿®æ­£ï¼‰ã€‚
2.  **é‡‡ç”¨ `Arc<Mutex<Engine>>` æ¨¡å¼**ï¼ˆè¿™æ˜¯ P1 çº§çš„æ¶æ„ä¼˜åŒ–ï¼‰ã€‚

**æ›´æ–°åçš„ç½®ä¿¡åº¦**: **95%** (ä¿®æ­£ä¸Šè¿°é€»è¾‘å)

è¿™ä»½æ–‡æ¡£ç°åœ¨å¯ä»¥ä½œä¸ºå®æ–½è“å›¾äº†ã€‚Phase 0.1 å¯ä»¥ç«‹å³å¯åŠ¨ã€‚

---

ä¸‹é¢æ˜¯å¯¹ v1.4 æ›´æ–°ç‰ˆè®¾è®¡æ–‡æ¡£çš„ç»§ç»­ Reviewï¼ˆåå·¥ç¨‹è½åœ°ä¸é£é™©/bug è§†è§’ï¼‰ã€‚æ•´ä½“ç»“è®ºï¼š**æ–¹å‘æ›´å¯¹äº†ï¼Œä½†å½“å‰å®ç°é‡Œå‡ºç°äº†å‡ ä¸ªâ€œä¼šå¯¼è‡´å®é™…æ•ˆæœ/æ€§èƒ½ä¸é¢„æœŸä¸ä¸€è‡´â€çš„å…³é”®é—®é¢˜**ï¼Œè¿™äº›é—®é¢˜ä¼šæ˜¾è‘—å½±å“ä½ ç»™å‡ºçš„ç½®ä¿¡åº¦è¯„ä¼°ã€‚

## 0. æ€»ä½“ç½®ä¿¡åº¦å»ºè®®ï¼ˆåŸºäº v1.4 å½“å‰æ–‡æœ¬ï¼‰

- æˆ‘ä¼šæŠŠ **æ€»ä½“ç½®ä¿¡åº¦ä» 72% è°ƒæ•´ä¸ºï¼š75%**
  - æŠ€æœ¯å¯è¡Œï¼š**85%ï¼ˆåŒæ„ï¼‰**
  - å†…å­˜ç›®æ ‡ï¼š**78%ï¼ˆæ¯”ä½ å†™çš„ 75%ç•¥é«˜ä¸€ç‚¹ï¼Œå› ä¸º session remove/è¶…æ—¶æ¸…ç†æ›´å®Œæ•´ï¼‰**
  - æ€§èƒ½ç›®æ ‡ï¼š**55%ï¼ˆæ¯”ä½ å†™çš„ 60%ç•¥ä½ä¸€ç‚¹ï¼‰**ï¼šä¸æ˜¯å› ä¸º Rust ç®—å¾—æ…¢ï¼Œè€Œæ˜¯**é”/dirty_rect è¯­ä¹‰/å‰ç«¯ bitmap å¼‚æ­¥æ¸²æŸ“é¡ºåº**ä¼šè®©ç«¯åˆ°ç«¯æ€§èƒ½ä¸è§†è§‰ä¸€è‡´æ€§å‡ºç°â€œä¸å¯æ§æ³¢åŠ¨â€ã€‚

ä¸‹é¢æ˜¯å…·ä½“é—®é¢˜ä¸ä¼˜åŒ–å»ºè®®ï¼ˆä¼˜å…ˆçº§ä»é«˜åˆ°ä½ï¼‰ã€‚

---

## 1) Rust ç«¯ï¼šå­˜åœ¨â€œå¿…ä¿®â€çš„å¹¶å‘æ­»é”é£é™©ï¼ˆP0ï¼‰

### 1.1 `evict_oldest()` ä¸ `remove_session()` é”é¡ºåºç›¸å

- `evict_oldest()`ï¼šå…ˆé” `session_order`ï¼Œå†é” `engines`
- `remove_session()`ï¼šå…ˆé” `engines`ï¼Œå†é” `session_order`

è¿™åœ¨å¹¶å‘ä¸‹æ˜¯ç»å…¸æ­»é”æ¨¡å‹ï¼šçº¿ç¨‹ A æ‹¿åˆ° order ç­‰ enginesï¼Œçº¿ç¨‹ B æ‹¿åˆ° engines ç­‰ orderã€‚

**ä¿®å¤å»ºè®®ï¼ˆä»»é€‰å…¶ä¸€ï¼Œå¼ºçƒˆå»ºè®® Aï¼‰ï¼š**
A. ç»Ÿä¸€å…¨å±€é”é¡ºåºï¼ˆå§‹ç»ˆå…ˆ engines å orderï¼Œæˆ–åè¿‡æ¥ï¼‰ï¼Œå¹¶åœ¨æ–‡æ¡£é‡Œå†™æˆ hard ruleã€‚
B. åˆå¹¶ä¸ºä¸€ä¸ª Mutex åŒ…å« `{engines, session_order, counter}`ï¼ˆä½  v1.3 å…¶å®æ›´å®‰å…¨ï¼‰ï¼Œç„¶å session å†…éƒ¨å†ç”¨ per-engine é”ã€‚
C. ä½¿ç”¨ `parking_lot::Mutex` + `try_lock` åšé€€é¿ï¼ˆä¸æ¨èå½“ MVP ä¸»æ–¹æ¡ˆï¼Œå¤æ‚åº¦é«˜ï¼‰ã€‚

> è¿™ä¸ªé—®é¢˜ä¸ä¿®ï¼Œçº¿ä¸Šå¶ç°ä¸€æ¬¡å°±ä¼šé€ æˆç»˜ç”»å¡æ­»ã€‚

---

## 2) Rust ç«¯ï¼šper-session äº’ä¸é˜»å¡çš„ç›®æ ‡ç›®å‰æ²¡è¾¾æˆï¼ˆP0ï¼‰

ä½ å†™äº†â€œsession ä¸äº’é”â€ï¼Œä½† `rust_brush_input` / `begin_stroke` ç­‰å‡½æ•°é‡Œæ˜¯è¿™æ ·ï¼š

```rust
let engines = state.engines.lock().unwrap();
let engine_mutex = engines.get(&session_id)...;
let mut engine = engine_mutex.lock()...
```

ä¹Ÿå°±æ˜¯ï¼š**æ‹¿ç€å…¨å±€ engines é”ï¼Œå†å»é”æŸä¸ª engine**ã€‚è¿™ä¼šå¯¼è‡´ï¼š

- ä»»ä½• session çš„ input éƒ½ä¼šé˜»å¡å…¶å®ƒ session çš„ start/end/get engineï¼ˆå› ä¸º engines é”è¢«é•¿æœŸæŒæœ‰ï¼‰
- `cleanup_stale_sessions()` è¿˜ä¼šåœ¨æŒæœ‰ engines é”æœŸé—´éå†å¹¶å°è¯•é”æ¯ä¸ª engineï¼Œè¿›ä¸€æ­¥æ”¾å¤§é˜»å¡

**å»ºè®®çš„ç»“æ„ï¼ˆå¼ºçƒˆå»ºè®®æ”¹ HashMap value ä¸º `Arc<Mutex<Engine>>`ï¼‰ï¼š**

- `HashMap<String, Arc<Mutex<StreamingBrushEngine>>>`
- æŸ¥åˆ° `Arc` åç«‹åˆ» `drop(engines_lock)`ï¼Œå†é” engine
- è¿™æ ·æ‰çœŸæ­£å®ç°â€œåªåœ¨æŸ¥è¡¨æ—¶çŸ­æŒæœ‰å…¨å±€é”â€

---

## 3) Rust ç«¯ï¼š`get_sync_data()` çš„ dirty_rect è¯­ä¹‰åœ¨ v1.4 å˜å¾—ä¸ä¸€è‡´ï¼ˆP0ï¼‰

### 3.1 å½“å‰ä»£ç ä¼šâ€œé‡å¤å‘é€æ—§è„åŒºâ€æˆ–å¯¼è‡´ dirty_bytes æ°¸è¿œå¢å¤§

v1.3 åœ¨ `get_sync_data()` ç»“æŸæ—¶ä¼šï¼š

- `dirty_rect = empty()`

ä½† v1.4 é‡Œä½ æ”¹æˆï¼š

```rust
// Reset sync state (ä¸æ¸…ç©ºæ•´ä¸ª dirty_rectï¼Œä¿ç•™ç”¨äºç´¯ç§¯)
self.dab_counter = 0;
self.last_sync = Instant::now();
```

è¿™ä¼šäº§ç”Ÿä¸¤ä¸ªä¸¥é‡åæœï¼š

1. **é‡å¤å‘é€**ï¼šä¸‹ä¸€æ¬¡åŒæ­¥ä»ä¼šæŠŠä¸Šä¸€æ¬¡å·²ç»å‘é€è¿‡çš„åŒºåŸŸå†å‘ä¸€éï¼ˆå› ä¸º dirty_rect æ²¡æ¸…ï¼‰ã€‚
2. **åŒæ­¥é˜ˆå€¼å¤±æ•ˆ**ï¼š`dirty_rect_bytes_safe()` ä¼šè¶Šæ¥è¶Šå¤§ï¼Œå¯¼è‡´åç»­æ¯ä¸ªç‚¹éƒ½è§¦å‘ needs_syncï¼Œæ¶ˆæ¯é£æš´/é˜Ÿåˆ—çˆ†ç‚¸ï¼Œç„¶åå‰ç«¯ä¸¢å¸§ä¼šå˜å¾—æ›´é¢‘ç¹ï¼Œç”»é¢æ›´æŠ–ã€‚

> å¦‚æœä½ çš„ç›®æ ‡æ˜¯â€œæ¯æ¬¡åŒæ­¥å‘ deltaï¼ˆå¢é‡ï¼‰â€ï¼Œé‚£å¿…é¡»åœ¨åŒæ­¥åæ¸… dirty_rectã€‚
> å¦‚æœç›®æ ‡æ˜¯â€œæ¯æ¬¡åŒæ­¥å‘å½“å‰ stroke çš„å…¨é‡ dirtyï¼ˆéå¢é‡ï¼‰â€ï¼Œé‚£è¦æ˜ç¡®ï¼šå‰ç«¯åº”è¯¥è¦†ç›–ç»˜åˆ¶åŒä¸€åŒºåŸŸæ²¡é—®é¢˜ï¼Œä½†å¸¦å®½/CPU ä¼šè¢«æµªè´¹ã€‚

**å»ºè®®ï¼šæ¢å¤ v1.3 è¡Œä¸ºï¼šåŒæ­¥åæ¸… dirty_rect**

- `get_sync_data()` å–å®Œæ•°æ®åï¼š`self.dirty_rect = Rect::empty();`
- `end_stroke()` å†æŠŠâ€œæœ¬ stroke çš„æ€» dirtyâ€ä¿å­˜åˆ° `last_stroke_dirty`ï¼šè¿™éœ€è¦ä¸€ä¸ªé¢å¤–å­—æ®µç´¯è®¡æ€» dirtyï¼ˆä¾‹å¦‚ `stroke_total_dirty`ï¼‰ï¼Œå¦åˆ™ä½ æ¸…æ‰äº† dirty_rect å°±ä¸¢ä¿¡æ¯ã€‚

ä¸€ä¸ªæ›´ä¸€è‡´çš„åšæ³•ï¼š

- `dirty_rect`ï¼šè‡ªä¸Šæ¬¡ sync ä»¥æ¥çš„å¢é‡ dirtyï¼ˆsync åæ¸…ï¼‰
- `stroke_total_dirty`ï¼šæœ¬ stroke æ€» dirtyï¼ˆç”¨äº begin_stroke æ¸…ç†ä¸ç»Ÿè®¡ï¼Œend_stroke åèµ‹ç»™ last_stroke_dirtyï¼‰

---

## 4) Rust ç«¯ï¼š`cleanup_stale_sessions()` é€»è¾‘å¯èƒ½â€œé”ä½å…¨ä¸–ç•Œâ€ï¼ˆP1ï¼‰

ç›®å‰åšæ³•æ˜¯æŒæœ‰ `engines` é”ï¼Œç„¶åéå†å¹¶å¯¹æ¯ä¸ª `engine_mutex.lock()`ã€‚
è¿™ä¼šé€ æˆï¼š

- å…¶å®ƒçº¿ç¨‹æ— æ³• `rust_brush_start/remove_session`ï¼ˆå› ä¸º engines é”è¢«ä½ æŒæœ‰ï¼‰
- å¦‚æœæŸä¸ª engine æ­£åœ¨ stampï¼ˆé•¿æ—¶é—´æŒé”ï¼‰ï¼Œæ¸…ç†çº¿ç¨‹ä¼šå¡ä½ï¼Œå¯¼è‡´å…¨å±€ç®¡ç†åŠŸèƒ½è¢«æŒ‚èµ·

**å»ºè®®ï¼šä¸¤é˜¶æ®µæ¸…ç†**

1. æŒæœ‰ engines é”ï¼Œå…ˆ clone å‡ºæ‰€æœ‰ `(id, Arc<Mutex<Engine>>)` çš„åˆ—è¡¨ï¼Œç„¶å drop engines é”
2. å†é€ä¸ª lock engine æ£€æŸ¥è¶…æ—¶ï¼Œæ”¶é›† stale ids
3. æœ€åé‡æ–°é” engines/order åš remove

---

## 5) å‰ç«¯ï¼š`createImageBitmap` åˆ†æ”¯å­˜åœ¨é¡ºåºä¸å¹¶å‘é—®é¢˜ï¼ˆP0/P1ï¼‰

### 5.1 `handleSync()` æ²¡æœ‰ `await renderWithBitmap()`

ä½ è¿™é‡Œï¼š

```ts
if (this.renderStrategy === 'createImageBitmap') {
  this.renderWithBitmap(...)
}
```

`renderWithBitmap` æ˜¯ asyncï¼Œä½†ä½ æ²¡ awaitï¼Œä¼šå¯¼è‡´ï¼š

- å¤šæ¡æ¶ˆæ¯çš„ bitmap åˆ›å»ºä¸ drawImage **ä¹±åºå®Œæˆ**
- æ—§å¸§å¯èƒ½åœ¨æ–°å¸§ä¹‹åæ‰ç»˜åˆ¶ï¼Œäº§ç”Ÿâ€œå›è·³/é—ªçƒâ€
- é˜Ÿåˆ—ä¸¢å¸§ç­–ç•¥ä¹Ÿä¼šè¢« async ç»•è¿‡ï¼ˆé˜Ÿåˆ—æ¸…äº†ï¼Œä½†æ¸²æŸ“è¿˜åœ¨é£ï¼‰

**ä¿®å¤å»ºè®®ï¼šä¸²è¡ŒåŒ– bitmap æ¸²æŸ“**

- ç»´æŠ¤ä¸€ä¸ª `this.bitmapChain: Promise<void> = Promise.resolve()`
- æ¯æ¬¡æ”¶åˆ°æ¶ˆæ¯ï¼š`this.bitmapChain = this.bitmapChain.then(() => this.renderWithBitmap(...))`
- æˆ–è€…åœ¨ RAF é‡Œ `await` å¤„ç†ï¼ˆæ³¨æ„ä¸è¦æŠŠ RAF callback å˜æˆ async å¯¼è‡´åå¼‚å¸¸ï¼Œéœ€è‡ªå·±å°è£…ï¼‰

### 5.2 `createImageBitmap(ImageData)` æœ¬èº«å¯èƒ½æ¯” putImageData æ›´è´µ

æ–‡æ¡£é‡ŒæŠŠå®ƒå½“â€œGPU åŠ é€Ÿå¤‡é€‰â€æ˜¯å¯¹çš„ï¼Œä½†çœŸå®ä¸–ç•Œé‡Œï¼š

- `createImageBitmap` ä¼šåšæ‹·è´/è½¬æ¢ï¼ŒæŸäº›æµè§ˆå™¨ä¸Šå¹¶ä¸ä¾¿å®œ
- å¦‚æœä½ æ¯å¸§å¤„ç† 4 æ¡æ¶ˆæ¯ï¼Œæ¯æ¡éƒ½ createImageBitmapï¼Œæˆæœ¬å¯èƒ½æ¯” putImageData æ›´é«˜

**å»ºè®®å†™å…¥æ–‡æ¡£çš„ç­–ç•¥**ï¼ˆæ›´ç¨³ï¼‰ï¼š

- é»˜è®¤ putImageData
- å½“æ£€æµ‹åˆ° putImageData P95 è¶…é˜ˆå€¼æ—¶ï¼Œåˆ‡ bitmap
- bitmap ç­–ç•¥ä¸‹ï¼šå°½é‡åˆå¹¶æ¶ˆæ¯ï¼ˆåªç”»æœ€æ–°ä¸€å¸§ï¼‰ï¼Œä¸è¦æ¯æ¡éƒ½ bitmap

---

## 6) æ™ºèƒ½æ¸…ç©ºï¼ˆbegin_stroke æ¸… dirtyï¼‰æ˜¯å¥½æ–¹å‘ï¼Œä½†è¦è¡¥é½è¾¹ç•Œè¯­ä¹‰ï¼ˆP1ï¼‰

ä½ ç°åœ¨ä¾èµ– `last_stroke_dirty` æ¥æ¸…ç†ä¸Šä¸€æ¬¡ stroke çš„åŒºåŸŸï¼Œè¿™ä¸ªæ–¹å‘å¾ˆæ­£ç¡®ï¼ˆé¿å… 4K fill(0)ï¼‰ã€‚
ä½†è¦æ³¨æ„å‡ ä¸ªè¾¹ç•Œï¼š

- å¦‚æœ stroke è¿‡ç¨‹ä¸­åŒæ­¥åæ¸…äº† dirty_rectï¼ˆä½ åº”è¯¥ä¼šæ”¹å›å»ï¼‰ï¼Œé‚£ `end_stroke` æ—¶æ‹¿ä¸åˆ°â€œæ€» dirtyâ€ï¼Œä¼šå¯¼è‡´ä¸‹ä¸€ç¬”æ²¡æ¸…å¹²å‡€ï¼Œæ®‹å½±é£é™©ã€‚
- å¦‚æœç”¨æˆ·ä¸­é€”å¼‚å¸¸é€€å‡ºï¼ˆsession è¶…æ—¶æ¸…ç†ï¼‰æ²¡æœ‰è°ƒç”¨ `end_stroke`ï¼Œä¸‹ä¸€æ¬¡å¤ç”¨åŒ sessionï¼ˆä½ ç°åœ¨ end ä¼š removeï¼Œé€šå¸¸ä¸ä¼šå¤ç”¨ï¼‰è¿˜å¥½ï¼›ä½†å¦‚æœæœªæ¥æ”¹æˆ session é•¿é©»ï¼Œå°±è¦å¤„ç†è¯¥æƒ…å†µã€‚

å»ºè®®æŠŠâ€œæ¸…ç†è¯­ä¹‰â€åœ¨æ–‡æ¡£é‡Œå†™æˆå¯éªŒè¯è§„åˆ™ï¼š

- Stroke Layer å¿…é¡»åœ¨ begin_stroke åå¤„äºå…¨é€æ˜ï¼ˆè‡³å°‘åœ¨ç”¨æˆ·å¯èƒ½è§¦åŠåŒºåŸŸå…¨é€æ˜ï¼‰ã€‚

---

## 7) æ–‡æ¡£å±‚é¢å»ºè®®è¡¥å¼ºï¼ˆæå‡ç½®ä¿¡åº¦çš„å…³é”®ï¼‰

ä¸ºäº†æŠŠæ€§èƒ½ç›®æ ‡ç½®ä¿¡åº¦ä» 55~60% æ‹‰ä¸Šå»ï¼Œå»ºè®®åœ¨ v1.5 å¢åŠ  3 ä¸ªâ€œå¯æ‰§è¡ŒéªŒæ”¶â€ï¼š

1. **é”/å¹¶å‘éªŒæ”¶**

- è§„å®šé”é¡ºåº
- åŠ ä¸€ä¸ªç®€å•çš„å‹åŠ›æµ‹è¯•ï¼ˆå¤š session å¹¶å‘ start/input/end + è¶…æ—¶æ¸…ç†ï¼‰ç¡®ä¿ä¸ä¼šæ­»é”

2. **dirty_rect è¯­ä¹‰éªŒæ”¶**

- å•æµ‹ï¼šstampâ†’syncâ†’stampâ†’sync ä¸ä¼šé‡å¤å‘é€ä¸Šä¸€è½®æ•°æ®ï¼ˆé™¤éæ˜ç¡®è®¾è®¡ä¸ºå…¨é‡è¦†ç›–ï¼‰
- å•æµ‹ï¼šbegin_stroke ååŒåŒºåŸŸåƒç´ ä¸º 0ï¼ˆé€æ˜ï¼‰

3. **å‰ç«¯æ¸²æŸ“é¡ºåºéªŒæ”¶**

- bitmap ç­–ç•¥å¿…é¡»ä¿è¯â€œæœ€åä¸€å¸§å¿…ç„¶æœ€åç»˜åˆ¶â€ï¼ˆä¸ä¹±åºï¼‰

---

## ç»“è®ºï¼šv1.4 ç›¸å¯¹ v1.3 çš„è¿›æ­¥ä¸å½“å‰æœ€å¤§é˜»ç¢

**è¿›æ­¥éå¸¸æ˜æ˜¾**ï¼šsession removeã€æ™ºèƒ½æ¸…ç©ºã€æ¸²æŸ“ç­–ç•¥å¯åˆ‡æ¢ã€ä¸¢å¸§ã€è¶…æ—¶æ¸…ç†éƒ½è®©æ–¹æ¡ˆæ›´åƒâ€œèƒ½é•¿æœŸè¿è¡Œçš„äº§å“ä»£ç â€ã€‚

**ä½† v1.4 çš„æœ€å¤§é˜»ç¢æ˜¯ 3 ä¸ª P0ï¼š**

1. `evict_oldest/remove_session` é”é¡ºåºåè½¬å¯¼è‡´æ­»é”é£é™©
2. engines å…¨å±€é”æŒæœ‰æœŸé—´é” engineï¼Œå¯¼è‡´â€œå¤š session äº’ä¸é˜»å¡â€åä¸å‰¯å®
3. `dirty_rect` åœ¨ sync åä¸æ¸…å¯¼è‡´é‡å¤å‘é€/é˜ˆå€¼å¤±æ•ˆï¼ˆä¼šå¼•çˆ†å‰ç«¯é˜Ÿåˆ—ä¸ä¸¢å¸§ï¼‰

ä½ å¦‚æœæ„¿æ„ï¼Œæˆ‘å¯ä»¥ç›´æ¥ç»™ä¸€ä»½â€œv1.4 -> v1.4.1â€çš„**æœ€å°æ”¹åŠ¨ patch æ–¹æ¡ˆ**ï¼ˆRust ä¾§ç”¨ Arcã€ç»Ÿä¸€é”é¡ºåºã€æ‹†åˆ† dirty_rect/stroke_total_dirtyï¼Œå‰ç«¯ bitmap ä¸²è¡Œé“¾ï¼‰ï¼Œè¿™æ ·èƒ½æŠŠæ•´ä½“ç½®ä¿¡åº¦æ‹‰åˆ° **80%+**ã€‚
