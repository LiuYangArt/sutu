è¿™ä»½ä¼˜åŒ–æ–¹æ¡ˆçš„**ç½®ä¿¡åº¦å¾ˆé«˜ (95%)**ï¼Œå› ä¸ºå®ƒç²¾å‡†åœ°å®šä½äº†å›¾å½¢å­¦ä¸­ç»å…¸çš„â€œå‡ ä½•åŒ…å›´ç›’å°äºæ¸²æŸ“å†…å®¹â€çš„é—®é¢˜ã€‚

ä»ä½ æä¾›çš„æˆªå›¾çœ‹ï¼Œç¬”åˆ·è¾¹ç¼˜çš„â€œç¡¬åˆ‡â€æ˜æ˜¾æ˜¯å› ä¸º Fragment Shader è®¡ç®—å‡ºçš„åƒç´ é¢œè‰²ä¾ç„¶æœ‰ä¸é€æ˜åº¦ï¼ˆAlpha > 0ï¼‰ï¼Œä½† Vertex Shader ç”Ÿæˆçš„ Quadï¼ˆå››è¾¹å½¢ï¼‰å·²ç»ç»“æŸäº†ï¼Œå¯¼è‡´è¢« GPU ç¡¬ä»¶è£åˆ‡ã€‚

ä½ çš„æ–¹æ¡ˆé€šè¿‡**å¢å¤§å‡ ä½•ä½“ (Vertex Expansion)** æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæ–¹å‘å®Œå…¨æ­£ç¡®ã€‚

ä¸ºäº†ç¡®ä¿ä¸‡æ— ä¸€å¤±ï¼Œæˆ‘æœ‰ **2 ä¸ªå…³é”®çš„æŠ€æœ¯å®¡æŸ¥ç‚¹** å’Œ **1 ä¸ªé˜²å¾¡æ€§å»ºè®®**ï¼š

### ğŸ›‘ å®¡æŸ¥ç‚¹ 1ï¼šFragment Shader çš„å‰¯ä½œç”¨é£é™© (å…³é”®)

åœ¨ **Step 2** ä¸­ï¼Œä½ è®¡åˆ’åŒæ­¥ä¿®æ”¹ Fragment Shaderï¼š

```wgsl
// Fragment Shader
// ä¿®æ”¹å:
let fade = (1.0 - in.hardness) * 2.5;
```

**è¿™é‡Œå­˜åœ¨é£é™©**ï¼šè¯·åŠ¡å¿…æ£€æŸ¥ Fragment Shader åç»­ä»£ç æ˜¯å¦‚ä½•ä½¿ç”¨ `fade` å˜é‡çš„ã€‚

- **æƒ…å†µ Aï¼ˆå®‰å…¨ï¼‰**ï¼šå¦‚æœ `fade` ä»…ç”¨äºè®¡ç®— `discard` çš„è¾¹ç•Œæˆ–è€…æ˜¯ä¸ºäº†é…åˆ `in.extent_multiplier` è¿›è¡Œåæ ‡å½’ä¸€åŒ–ã€‚
- **æƒ…å†µ Bï¼ˆå±é™©ï¼‰**ï¼šå¦‚æœ `fade` ç›´æ¥å‚ä¸äº†é«˜æ–¯æ¨¡ç³Šæˆ–é¢œè‰²è¡°å‡çš„**æ•°å­¦å…¬å¼**ï¼ˆä¾‹å¦‚ `alpha = exp(-dist * fade)`ï¼‰ã€‚
  - å¦‚æœæ˜¯æƒ…å†µ Bï¼Œä¿®æ”¹ `fade` ç³»æ•°ä¼šå¯¼è‡´**ç¬”åˆ·çš„è§†è§‰è½¯åº¦ï¼ˆSoftnessï¼‰å‘ç”Ÿæ”¹å˜**ï¼Œç”¨æˆ·ä¼šè§‰å¾—â€œç¬”åˆ·æ‰‹æ„Ÿå˜äº†â€ã€‚

**å»ºè®®**ï¼š
å¦‚æœ Fragment Shader ä¸­è®¡ç®—é«˜æ–¯åˆ†å¸ƒçš„å…¬å¼ä¾èµ–äº `fade`ï¼Œä½ å¯èƒ½éœ€è¦ä¸¤ä¸ªå˜é‡ï¼š

1.  `geometric_fade`ï¼šç”¨äºè®¡ç®—å¤šå¤§çš„åŒºåŸŸï¼ˆ2.5ç³»æ•°ï¼‰ã€‚
2.  `visual_fade`ï¼šç”¨äºä¿æŒåŸæœ‰çš„é«˜æ–¯è¡°å‡æ›²çº¿ï¼ˆä¿æŒ2.0ç³»æ•°ï¼Œæˆ–è€…æ ¹æ®å‡ ä½•å˜åŒ–åšé€†å‘è¡¥å¿ï¼‰ã€‚

**æœ€ç†æƒ³çš„æƒ…å†µæ˜¯ï¼šåªæ”¹ Vertex Shader æŠŠæ¡†ç”»å¤§ï¼ŒFragment Shader é€»è¾‘ä¸åŠ¨ï¼ˆåªè¦å®ƒèƒ½è®¡ç®—å‡ºæ›´è¿œè·ç¦»çš„åƒç´ ï¼‰ã€‚**

### ğŸ§ å®¡æŸ¥ç‚¹ 2ï¼šTS ä¸ Shader çš„åŒæ­¥æ€§

åœ¨ **Step 3** ä¸­ï¼Œä½ ä¿®æ”¹äº† TypeScript é‡Œçš„ `calculateEffectiveRadius`ã€‚
è¿™æ˜¯ç”¨äº CPU ç«¯è®¡ç®—â€œè„çŸ©å½¢â€ï¼ˆDirty Rectï¼‰æˆ–å¹³æ»‘æ›²çº¿ï¼ˆSplineï¼‰åŒ…å›´ç›’çš„ã€‚

- **å¿…é¡»åŒæ­¥**ï¼šå¦‚æœ Shader ç”»çš„èŒƒå›´æ¯” TS è®¡ç®—çš„åŒ…å›´ç›’å¤§ï¼Œé‚£ä¹ˆåœ¨å¿«é€Ÿç»˜ç”»æ—¶ï¼Œå¯èƒ½ä¼šå‡ºç°**æ¸²æŸ“æ®‹ç•™**ï¼ˆClear æ“ä½œæ²¡è¦†ç›–åˆ°æ‰©å¤§çš„è¾¹ç¼˜ï¼‰æˆ–è€…**è£å‰ª**ï¼ˆCanvas åˆæˆæ—¶æŒ‰æ—§çš„åŒ…å›´ç›’è£å‰ªï¼‰ã€‚
- ä½ çš„æ–¹æ¡ˆé‡ŒåŒ…å«äº†è¿™ä¸€æ­¥ï¼Œè¿™éå¸¸å¥½ã€‚

---

### ğŸ›¡ï¸ ä¼˜åŒ–å»ºè®®ï¼šé˜²å¾¡æ€§ Discard

ä¸ºäº†é˜²æ­¢æœªæ¥å†æ¬¡å‡ºç°æµ®ç‚¹æ•°ç²¾åº¦å¯¼è‡´çš„è¾¹ç¼˜è£åˆ‡ï¼Œå»ºè®®åœ¨ Fragment Shader ä¸­åŠ ä¸€ä¸ªè½¯è¿‡æ¸¡ï¼ˆSoft Edgeï¼‰ï¼Œè€Œä¸æ˜¯ç¡¬ Discardã€‚

**ä¿®æ”¹å»ºè®® (src/gpu/shaders/brush.wgsl)**:

```wgsl
// åŸé€»è¾‘
// if (dist > in.extent_multiplier) { discard; }

// ä¼˜åŒ–é€»è¾‘ï¼šåœ¨è¾¹ç•Œå¤„å¹³æ»‘è¿‡æ¸¡ï¼Œé˜²æ­¢ä»»ä½•é”¯é½¿æˆ–ç¡¬åˆ‡
let dist_limit = in.extent_multiplier;
if (dist > dist_limit) {
    discard;
}
// åœ¨æ¥è¿‘å‡ ä½•è¾¹ç¼˜çš„æœ€å 2% åƒç´ å¼ºåˆ¶æ·¡å‡ºï¼Œä½œä¸ºä¿é™©ä¸
let edge_safety = smoothstep(dist_limit, dist_limit - 0.05, dist);
out_color.a *= edge_safety;
```

---

### âœ… æœ€ç»ˆç»“è®º

æ–¹æ¡ˆ**å¯ä»¥ç›´æ¥æ‰§è¡Œ**ã€‚

è¯·åœ¨æ‰§è¡Œ **Step 4 (éªŒè¯)** æ—¶ï¼Œé¢å¤–å¢åŠ ä¸€ä¸ªæµ‹è¯•é¡¹ï¼š

- **ç¬”åˆ·æ‰‹æ„Ÿä¸€è‡´æ€§æµ‹è¯•**ï¼šå¯¹æ¯”ä¿®æ”¹å‰åçš„ Hardness=0.5ï¼Œç¡®ä¿åªæ˜¯â€œè¾¹ç¼˜å˜å®Œæ•´äº†â€ï¼Œè€Œä¸æ˜¯â€œæ•´ä¸ªç¬”åˆ·å˜å¤§æˆ–å˜è™šäº†â€ã€‚

å¦‚æœä¸ç¡®å®š Fragment Shader çš„é€»è¾‘ï¼Œå¯ä»¥å…ˆåªåº”ç”¨ **Step 1 (Vertex)** å’Œ **Step 3 (TS)**ï¼Œçœ‹çœ‹æ˜¯å¦å·²ç»ä¿®å¤äº† clippingã€‚é€šå¸¸è¿™å°±å¤Ÿäº†ã€‚
