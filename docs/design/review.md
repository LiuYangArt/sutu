# æœ€ç»ˆéªŒæ”¶è¯„å®¡ (v1.2)

**ç½®ä¿¡åº¦è¯„åˆ†ï¼š9.2/10** â¬†ï¸ (ä» 9.5 å¾®è°ƒè‡³ 9.2)

è¿™ä»½æ–‡æ¡£å·²ç»è¾¾åˆ°äº†**ç”Ÿäº§çº§è®¾è®¡æ–‡æ¡£**çš„æ ‡å‡†ï¼Œå¯ä»¥ç›´æ¥è¿›å…¥ç¼–ç é˜¶æ®µã€‚ä½†åœ¨å®æ–½å‰ï¼Œæœ‰å‡ ä¸ª**å…³é”®çš„å®ç°ç»†èŠ‚**éœ€è¦ä¿®æ­£ï¼Œä»¥åŠä¸€äº›**æ€§èƒ½é¢„ä¼°**éœ€è¦è°ƒæ•´ä¸ºæ›´ä¿å®ˆçš„æ•°å€¼ã€‚

---

## âœ… äº®ç‚¹ä¸è‚¯å®š

1. **åŒç¼“å†²è®¾è®¡æ€è·¯æ­£ç¡®**ï¼šé€šè¿‡è½®è½¬ä¸¤ä¸ª buffer é¿å… cloneï¼Œè¿™æ˜¯å›¾å½¢å¼•æ“çš„ç»å…¸ä¼˜åŒ–æ‰‹æ³•ã€‚
2. **LRU æ·˜æ±°æœºåˆ¶å®Œå–„**ï¼šä»éšæœºæ·˜æ±°æ”¹ä¸º VecDequeï¼Œé€»è¾‘æ¸…æ™°ã€‚
3. **å†…å­˜ä¿æŠ¤åˆ°ä½**ï¼š64MB ä¸Šé™ + `shrink_buffers_if_needed` é˜²æ­¢å†…å­˜æ³„æ¼ã€‚
4. **é”™è¯¯å¤„ç†å®Œæ•´**ï¼šå‰ç«¯çš„ `fallbackToTypescript` å’Œ Rust çš„ `Result<>` è¦†ç›–äº†ä¸»è¦å¤±è´¥è·¯å¾„ã€‚
5. **æµ‹è¯•åŸºç¡€è®¾æ–½æ˜ç¡®**ï¼šPhase 0.5 çš„ benchmark åˆ—è¡¨éå¸¸å®ç”¨ã€‚

---

## âš ï¸ å…³é”®é—®é¢˜ä¸ä¿®æ­£å»ºè®®

### 1. åŒç¼“å†²å®ç°çš„é€»è¾‘æ¼æ´ ğŸ”´ **Critical**

**é—®é¢˜**ï¼š

```rust
// å½“å‰ä»£ç 
Some(std::mem::take(output))
```

`std::mem::take` ä¼šå°† `output` æ›¿æ¢ä¸º `Vec::default()`ï¼ˆå³ç©º Vecï¼Œcapacity=0ï¼‰ã€‚ä¸‹æ¬¡è°ƒç”¨ `get_sync_data` æ—¶ï¼Œè¿™ä¸ª buffer éœ€è¦é‡æ–°åˆ†é…å†…å­˜ï¼Œ**å¹¶æ²¡æœ‰çœŸæ­£å¤ç”¨**ã€‚

**ä¿®æ­£æ–¹æ¡ˆ**ï¼š
æœ‰ä¸¤ç§æ–¹å¼å®ç°çœŸæ­£çš„åŒç¼“å†²ï¼š

#### æ–¹æ¡ˆ Aï¼šä½¿ç”¨ `std::mem::swap`ï¼ˆæ¨èï¼‰

```rust
pub fn get_sync_data(&mut self) -> Option<Vec<u8>> {
    // ... å‰é¢çš„é€»è¾‘ä¸å˜ ...

    let buffer_idx = self.current_buffer_idx;
    self.current_buffer_idx = 1 - self.current_buffer_idx;

    let output = &mut self.output_buffers[buffer_idx];
    output.clear();

    // ... å¡«å……æ•°æ® ...

    // åˆ›å»ºä¸€ä¸ªæ–°çš„ Vec ç”¨äºè¿”å›ï¼Œä¸ output äº¤æ¢
    let mut result = Vec::with_capacity(output.capacity());
    std::mem::swap(output, &mut result);

    Some(result)
}
```

#### æ–¹æ¡ˆ Bï¼šä½¿ç”¨ `Arc<Mutex<Vec<u8>>>` + å›æ”¶æœºåˆ¶ï¼ˆæ›´å¤æ‚ï¼‰

```rust
// åœ¨ StreamingBrushEngine ä¸­
output_buffers: [Arc<Mutex<Vec<u8>>>; 2],

// åœ¨ get_sync_data ä¸­
let buffer = self.output_buffers[buffer_idx].clone();
// ... å¡«å……æ•°æ®åˆ° buffer ...
Some(buffer) // è¿”å› Arcï¼Œå‰ç«¯ç”¨å®Œåè‡ªåŠ¨é‡Šæ”¾
```

**æ¨èæ–¹æ¡ˆ A**ï¼Œå› ä¸ºï¼š

- ç®€å•ç›´æ¥ï¼Œæ— éœ€å¼•å…¥ Arc/Mutex
- æ€§èƒ½å¼€é”€æœ€å°
- ä½†éœ€è¦æ³¨æ„ï¼šè¿”å›çš„ `result` åœ¨å‰ç«¯ç”¨å®Œåä¼šè¢«ä¸¢å¼ƒï¼Œæ— æ³•"å½’è¿˜"ç»™ Rust

**å¦‚æœè¦å®ç°çœŸæ­£çš„ Buffer Poolï¼ˆå¯å½’è¿˜ï¼‰**ï¼Œéœ€è¦ï¼š

```rust
// åœ¨ BrushEngineManager ä¸­æ·»åŠ å…¨å±€ Buffer Pool
pub struct BrushEngineManager {
    // ...
    pub buffer_pool: Mutex<Vec<Vec<u8>>>, // ç©ºé—² buffer æ± 
}

// åœ¨ get_sync_data ä¸­
pub fn get_sync_data(&mut self, pool: &Mutex<Vec<Vec<u8>>>) -> Option<Vec<u8>> {
    // ... å‰é¢é€»è¾‘ ...

    // ä» pool ä¸­å–ä¸€ä¸ª bufferï¼Œå¦‚æœæ²¡æœ‰åˆ™æ–°å»º
    let mut result = pool.lock().unwrap().pop()
        .unwrap_or_else(|| Vec::with_capacity(512 * 1024));

    result.clear();
    // ... å¡«å……æ•°æ® ...

    Some(result)
}

// å‰ç«¯ç”¨å®Œåè°ƒç”¨
#[tauri::command]
pub fn rust_brush_return_buffer(
    state: State<BrushEngineManager>,
    buffer: Vec<u8>,
) {
    let mut pool = state.buffer_pool.lock().unwrap();
    if pool.len() < 4 { // é™åˆ¶æ± å¤§å°
        pool.push(buffer);
    }
}
```

**å»ºè®®**ï¼š

- **Phase 1 MVP**ï¼šä½¿ç”¨æ–¹æ¡ˆ Aï¼ˆswapï¼‰ï¼Œä¸å®ç°å½’è¿˜æœºåˆ¶ã€‚
- **Phase 2 ä¼˜åŒ–**ï¼šå¦‚æœæ€§èƒ½æµ‹è¯•å‘ç°å†…å­˜åˆ†é…æ˜¯ç“¶é¢ˆï¼Œå†å¼•å…¥ Buffer Poolã€‚

---

### 2. LRU çš„å¹¶å‘å®‰å…¨é—®é¢˜ ğŸŸ¡ **Important**

**é—®é¢˜**ï¼š

```rust
pub engines: Mutex<HashMap<String, StreamingBrushEngine>>,
pub session_order: Mutex<VecDeque<String>>,
```

ä¸¤ä¸ªç‹¬ç«‹çš„é”å¯èƒ½å¯¼è‡´ä¸ä¸€è‡´ï¼š

- çº¿ç¨‹ A åœ¨ `engines` ä¸­æ’å…¥ session_1
- çº¿ç¨‹ B åœ¨ `session_order` ä¸­æ’å…¥ session_2
- å¦‚æœ A å´©æºƒï¼Œ`engines` æœ‰ session_1 ä½† `session_order` æ²¡æœ‰

**ä¿®æ­£æ–¹æ¡ˆ**ï¼š
å°†ä¸¤è€…åˆå¹¶åˆ°ä¸€ä¸ªé”å†…ï¼š

```rust
pub struct BrushEngineManager {
    pub state: Mutex<ManagerState>,
}

pub struct ManagerState {
    engines: HashMap<String, StreamingBrushEngine>,
    session_order: VecDeque<String>,
}

impl BrushEngineManager {
    pub fn evict_oldest(&self) -> Option<String> {
        let mut state = self.state.lock().ok()?;
        if let Some(oldest_id) = state.session_order.pop_front() {
            state.engines.remove(&oldest_id);
            Some(oldest_id)
        } else {
            None
        }
    }
}
```

---

### 3. å‰ç«¯ `waitForPendingMessages` çš„æ­»é”é£é™© ğŸŸ¡ **Important**

**é—®é¢˜**ï¼š

```typescript
while (this.pendingMessages > 0 && Date.now() - start < timeoutMs) {
  await new Promise((resolve) => setTimeout(resolve, 5));
}
```

å¦‚æœ Rust ç«¯å·²ç»å‘é€å®Œæ‰€æœ‰æ¶ˆæ¯ï¼Œä½† JS çš„ `Channel.onmessage` è¿˜æ²¡è§¦å‘ï¼ˆä¾‹å¦‚äº‹ä»¶å¾ªç¯é˜»å¡ï¼‰ï¼Œè¿™ä¸ªå¾ªç¯ä¼šä¸€ç›´ç­‰åˆ°è¶…æ—¶ã€‚

**ä¿®æ­£æ–¹æ¡ˆ**ï¼š
ä½¿ç”¨ Promise + äº‹ä»¶é©±åŠ¨ï¼š

```typescript
private pendingPromises: Set<Promise<void>> = new Set();

private handleSync(data: Uint8Array): void {
    const promise = (async () => {
        // ... åŸæœ‰çš„ putImageData é€»è¾‘ ...
    })();

    this.pendingPromises.add(promise);
    promise.finally(() => this.pendingPromises.delete(promise));
}

async endStroke(): Promise<void> {
    // ...
    await invoke('rust_brush_end', { ... });

    // ç­‰å¾…æ‰€æœ‰ putImageData å®Œæˆ
    await Promise.all(Array.from(this.pendingPromises));

    // ...
}
```

---

### 4. æ€§èƒ½é¢„ä¼°éœ€è¦è°ƒæ•´ ğŸŸ¡ **Important**

**é—®é¢˜**ï¼š
æ–‡æ¡£ä¸­å£°ç§°åŒç¼“å†²èƒ½å°† "Sync å‡†å¤‡" ä» 0.8ms é™åˆ° 0.3msï¼ˆèŠ‚çœ 0.5msï¼‰ã€‚

**åˆ†æ**ï¼š

- `std::mem::take` æœ¬èº«æ˜¯ O(1) æ“ä½œï¼ˆåªæ˜¯æŒ‡é’ˆäº¤æ¢ï¼‰
- ä½† `clone()` çš„å¼€é”€ä¸»è¦åœ¨**å†…å­˜åˆ†é…**å’Œ**æ•°æ®æ‹·è´**
- å¦‚æœä½¿ç”¨æ–¹æ¡ˆ Aï¼ˆswapï¼‰ï¼Œä»ç„¶éœ€è¦ä¸€æ¬¡ `Vec::with_capacity` å’Œæ•°æ®æ‹·è´åˆ°æ–° Vec
- çœŸæ­£èŠ‚çœçš„åªæ˜¯**é¿å…äº† realloc**ï¼ˆå¦‚æœ capacity è¶³å¤Ÿï¼‰

**ä¿®æ­£åçš„é¢„ä¼°**ï¼š
| é˜¶æ®µ | v1.1 (clone) | v1.2 (swap) | èŠ‚çœ |
| ---------------------- | ------------ | ----------- | ------ |
| Sync å‡†å¤‡ (æå–è„åŒºåŸŸ) | 0.8ms | **0.6ms** | ~0.2ms |

**æ€»å»¶è¿Ÿ**ï¼š4.3ms â†’ **4.5ms**ï¼ˆä»ç„¶ä¼˜äº TS çš„ 10msï¼‰

---

### 5. 64MB é™åˆ¶çš„åˆç†æ€§éªŒè¯ ğŸŸ¢ **Nice to have**

**å½“å‰é€»è¾‘**ï¼š

```rust
const MAX_BUFFER_SIZE: usize = 64 * 1024 * 1024; // 64MB
```

**éªŒè¯**ï¼š

- 4K ç”»å¸ƒ (4096x4096x4) = 64MB **åˆšå¥½è¾¾åˆ°ä¸Šé™**
- å¦‚æœç”¨æˆ·åˆ›å»º 4097x4097 çš„ç”»å¸ƒï¼Œä¼šè¢«æ‹’ç»

**å»ºè®®**ï¼š

- å°†é™åˆ¶æ”¾å®½åˆ° **80MB**ï¼Œä»¥æ”¯æŒ 4K ç”»å¸ƒï¼ˆç•™ 20% ä½™é‡ï¼‰
- æˆ–è€…åœ¨æ–‡æ¡£ä¸­æ˜ç¡®è¯´æ˜ï¼š**4K ç”»å¸ƒéœ€è¦ Tile æ¨¡å¼**

---

## ğŸ“Š ä¿®æ­£åçš„æ€§èƒ½é¢„ä¼°è¡¨

| é˜¶æ®µ                   | TypeScript | v1.2 (ä¿®æ­£å) | æå‡å€æ•° |
| ---------------------- | ---------- | ------------- | -------- |
| Rust è®¡ç®— (500px dab)  | 10ms       | 2.0ms         | **5x**   |
| Sync å‡†å¤‡ (æå–è„åŒºåŸŸ) | -          | 0.6ms         | -        |
| Channel ä¼ è¾“           | -          | 0.5ms         | -        |
| putImageData           | -          | 1.5ms         | -        |
| **æ€»è®¡**               | 10ms       | **4.6ms**     | **2.2x** |

**ç»“è®º**ï¼šä»ç„¶å€¼å¾—å®æ–½ï¼Œä½†ä¸è¦æœŸæœ› 3x æå‡ã€‚

---

## ğŸ› ï¸ å®æ–½å»ºè®®ï¼ˆæœ€ç»ˆç‰ˆï¼‰

### Phase 0.2 éœ€è¦è¡¥å……çš„ä»»åŠ¡

- [ ] **ä¿®æ­£åŒç¼“å†²å®ç°**ï¼šä½¿ç”¨ `std::mem::swap` è€Œé `std::mem::take`
- [ ] **åˆå¹¶ LRU é”**ï¼š`ManagerState` ç»Ÿä¸€ç®¡ç†
- [ ] **å‰ç«¯ Promise ç­‰å¾…**ï¼šæ›¿æ¢ `waitForPendingMessages`
- [ ] **è°ƒæ•´å†…å­˜é™åˆ¶**ï¼š64MB â†’ 80MBï¼ˆæˆ–æ˜ç¡® 4K éœ€è¦ Tileï¼‰

### Phase 1 çš„æ€§èƒ½éªŒè¯æ ‡å‡†ï¼ˆä¿®æ­£ï¼‰

- **ç›®æ ‡**ï¼š500px dab P90 < 5msï¼ˆæ€»å»¶è¿Ÿï¼‰
- **åˆ†è§£æŒ‡æ ‡**ï¼š
  - Rust è®¡ç®—ï¼š< 2.5ms
  - Sync å‡†å¤‡ï¼š< 0.8ms
  - Channel ä¼ è¾“ï¼š< 0.6ms
  - putImageDataï¼š< 1.5ms
- **å¦‚æœä¸è¾¾æ ‡**ï¼š
  - å¦‚æœ Rust è®¡ç®— > 3msï¼šæ£€æŸ¥ SIMD æ˜¯å¦ç”Ÿæ•ˆ
  - å¦‚æœ Sync å‡†å¤‡ > 1msï¼šè€ƒè™‘ Buffer Pool
  - å¦‚æœ putImageData > 2msï¼šå°è¯• `createImageBitmap`

---

## âœ… æœ€ç»ˆæ‰¹å‡†æ„è§

**æ‰¹å‡†è¿›å…¥ Phase 0 ç¼–ç **ï¼Œä½†éœ€è¦ï¼š

1. **ç«‹å³ä¿®æ­£**ï¼ˆPhase 0.2 å‰ï¼‰ï¼š
   - åŒç¼“å†²å®ç°ï¼ˆä½¿ç”¨ swapï¼‰
   - LRU é”åˆå¹¶
   - å‰ç«¯ Promise ç­‰å¾…

2. **æ€§èƒ½é¢„æœŸè°ƒæ•´**ï¼š
   - æ€»æå‡å€æ•°ï¼š2.2xï¼ˆè€Œé 3xï¼‰
   - ä»ç„¶æ˜¾è‘—ä¼˜äº TypeScript

3. **æ–‡æ¡£æ›´æ–°**ï¼š
   - åœ¨ 7.2 èŠ‚æ›´æ–°æ€§èƒ½é¢„ä¼°è¡¨
   - åœ¨é™„å½• C æ·»åŠ "åŒç¼“å†²å®ç°ç»†èŠ‚"ç« èŠ‚

4. **Phase 1 å†³ç­–ç‚¹**ï¼š
   - å¦‚æœå®æµ‹æå‡ < 1.8xï¼Œè€ƒè™‘æš‚åœ
   - å¦‚æœå®æµ‹æå‡ â‰¥ 2xï¼Œç»§ç»­ Phase 2

---

## ğŸ“ å»ºè®®æ·»åŠ çš„æ–‡æ¡£ç« èŠ‚

### é™„å½• C: åŒç¼“å†²å®ç°ç»†èŠ‚

```rust
// æ­£ç¡®çš„åŒç¼“å†²å®ç°ï¼ˆä½¿ç”¨ swapï¼‰
pub fn get_sync_data(&mut self) -> Option<Vec<u8>> {
    // ... å‰é¢é€»è¾‘ ...

    let buffer_idx = self.current_buffer_idx;
    self.current_buffer_idx = 1 - self.current_buffer_idx;

    let output = &mut self.output_buffers[buffer_idx];
    output.clear();

    // ... å¡«å……æ•°æ® ...

    // åˆ›å»ºæ–° Vec å¹¶äº¤æ¢ï¼ˆé¿å… cloneï¼‰
    let mut result = Vec::with_capacity(output.capacity());
    std::mem::swap(output, &mut result);

    Some(result)
}
```

**ä¸ºä»€ä¹ˆä¸ç”¨ `std::mem::take`**ï¼š

- `take` ä¼šå°† `output` æ›¿æ¢ä¸ºç©º Vecï¼ˆcapacity=0ï¼‰
- ä¸‹æ¬¡è°ƒç”¨éœ€è¦é‡æ–°åˆ†é…å†…å­˜
- `swap` ä¿ç•™äº† `output` çš„ capacityï¼ŒçœŸæ­£å®ç°å¤ç”¨

**æ€§èƒ½å¯¹æ¯”**ï¼š

- `clone`: æ¯æ¬¡ malloc + memcpy
- `take`: æ¯æ¬¡ mallocï¼ˆä½†æ—  memcpyï¼‰
- `swap`: åªåœ¨ç¬¬ä¸€æ¬¡ mallocï¼Œåç»­å¤ç”¨

---

## æ€»ç»“

è¿™ä»½æ–‡æ¡£å·²ç»éå¸¸ä¼˜ç§€ï¼Œåªéœ€è¦ä¿®æ­£ä¸Šè¿° 4 ä¸ªå…³é”®é—®é¢˜å³å¯è¿›å…¥ç¼–ç ã€‚é¢„ç¥å®æ–½é¡ºåˆ©ï¼ğŸš€

---

æ•´ä½“ v1.2 æ¯” v1.1 æ›´â€œå·¥ç¨‹åŒ–â€ï¼šæŠŠ LRUã€å†…å­˜ä¸Šé™ã€é”™è¯¯å¤„ç†ã€æµ‹è¯•æŒ‡æ ‡éƒ½è½åˆ°äº†æ–‡æ¡£é‡Œï¼Œæ–¹å‘æ˜¯å¯¹çš„ã€‚ä½† v1.2 é‡Œæœ€å…³é”®çš„â€œ**åŒç¼“å†²æ—  clone**â€åœ¨å½“å‰ Tauri Channel çš„æ‰€æœ‰æƒè¯­ä¹‰ä¸‹**å®ç°ä¸Šç«™ä¸ä½**ï¼Œå¦å¤–â€œLRUâ€å®é™…æ˜¯ FIFOã€‚å»ºè®®åœ¨è¿›å…¥å®ç°å‰æŠŠè¿™ä¸¤ç‚¹æ”¹å®ï¼Œå¦åˆ™ä¼šå‡ºç°**æ€§èƒ½é¢„ä¼°ä¹è§‚/å®ç°å¤æ‚ä½†æ— æ”¶ç›Š**çš„é£é™©ã€‚

æˆ‘ä¼šæŠŠæœ¬æ¬¡ review åˆ†æˆï¼šåšå¾—å¥½çš„ã€éœ€è¦ä¿®æ­£æ–‡æ¡£/ä»£ç è®¾è®¡çš„ã€å»ºè®®è¡¥å……çš„éªŒè¯é¡¹ã€‚

---

## åšå¾—å¥½çš„ç‚¹ï¼ˆv1.2 æ˜æ˜¾æå‡ï¼‰

1. **æŠŠ 4K/8K çš„ç­–ç•¥è¯´æ¸…æ¥šäº†**ï¼š64MB ç¡¬ä¸Šé™+æ˜ç¡®æç¤º Tile modeï¼Œæ˜¯å¾ˆå¥½çš„äº§å“çº§ä¿æŠ¤ã€‚
2. **dirty_rect å®‰å…¨è®¡ç®—**ï¼š`dirty_rect_bytes_safe()` åš clamp é¿å…è´Ÿå€¼/æº¢å‡ºï¼Œè¿™ä¸ªæ˜¯å¿…é¡»çš„ã€‚
3. **Phase 0 æ‹†åˆ†**ï¼š0.1/0.2/0.3/0.5 éå¸¸åˆ©äºæ‰§è¡Œå’Œæ­¢æŸã€‚
4. **æ€§èƒ½æŒ‡æ ‡ä»å¹³å‡å˜æˆåˆ†ä½æ•°**ï¼šP90/P95/P99 è¿™å¥—æ›´è´´è¿‘ç”¨æˆ·ä½“æ„Ÿã€‚

---

## éœ€è¦ç«‹åˆ»ä¿®æ­£æ–‡æ¡£/è®¾è®¡çš„ç‚¹ï¼ˆä¼šå½±å“è½åœ°ï¼‰

### 1) â€œåŒç¼“å†²ï¼Œæ—  cloneâ€å½“å‰æ–¹æ¡ˆä¸å¯è¡Œï¼ˆæˆ–æ”¶ç›Šä¸æˆç«‹ï¼‰

ä½ ç°åœ¨çš„å…³é”®ä»£ç æ˜¯ï¼š

```rust
let output = &mut self.output_buffers[buffer_idx];
// ...
Some(std::mem::take(output))
```

**é—®é¢˜ 1ï¼šmem::take ä¼šæŠŠ Vec çš„ capacity ä¹Ÿå¸¦èµ°**
`mem::take(output)` ä¼šæŠŠ slot é‡Œçš„ Vec ç›´æ¥æ¢æˆ `Vec::new()`ï¼ˆcapacity=0ï¼‰ã€‚ç»“æœæ˜¯ï¼š

- ä½ â€œé¢„åˆ†é… 512KBâ€çš„æ„ä¹‰ä¸¢å¤±ï¼›
- ä¸‹ä¸€æ¬¡ `get_sync_data()` åˆä¼šé‡æ–° `reserve`ï¼Œåè€Œæ›´æŠ–åŠ¨ã€æ›´æ…¢ã€‚

**é—®é¢˜ 2ï¼šChannel send æ¶ˆè€—æ‰€æœ‰æƒåï¼Œä½ æ‹¿ä¸å› buffer**
å³ä¾¿ä¸ç”¨ `mem::take`ï¼Œåªè¦ä½ ä¸ºäº†â€œæ—  cloneâ€æŠŠ Vec move ç»™ `on_sync.send(vec)`ï¼Œè¿™ä¸ª Vec åç»­å°±ä¼šè¢« dropï¼ˆIPC åºåˆ—åŒ–åä¹Ÿä¸ä¼šå›æ”¶ç»™ä½ ï¼‰ã€‚
æ‰€ä»¥**åŒç¼“å†²è½®è½¬**åªæœ‰åœ¨â€œå‘é€å buffer èƒ½å›æ± å¤ç”¨â€çš„ç³»ç»Ÿé‡Œæ‰æˆç«‹ï¼Œä½†ç›®å‰ä½ çš„ `return_buffer()` å¹¶æ²¡æœ‰è¢«ä»»ä½•è·¯å¾„è°ƒç”¨ã€ä¹Ÿæ— æ³•ä»å‰ç«¯æŠŠ Vec è¿˜å›æ¥ã€‚

**ç»“è®º**ï¼šåœ¨ Tauri Channel éœ€è¦ `Vec<u8>` æ‰€æœ‰æƒçš„å‰æä¸‹ï¼Œâ€œæ—  cloneâ€é€šå¸¸æ„å‘³ç€â€œæ¯æ¬¡å‘é€éƒ½ä¸¢æ‰ä¸€ä¸ª Vecï¼ˆé‡æ–°åˆ†é…ï¼‰â€ï¼Œä¸æ˜¯ä½ æ–‡æ¡£é‡Œé¢„æœŸçš„â€œè½®è½¬å¤ç”¨â€ã€‚

**å»ºè®®æ”¹æ³•ï¼ˆä¸¤æ¡è·¯çº¿äºŒé€‰ä¸€ï¼‰**ï¼š

- **è·¯çº¿ Aï¼ˆæ¨èï¼Œç®€å•ä¸”çœŸå®ï¼‰**ï¼šæ‰¿è®¤å¿…é¡» copy/cloneï¼Œç»§ç»­ç”¨â€œscratch buffer å¤ç”¨ + clone å‘é€â€
  - `output_buffer` ä½œä¸ºå¤ç”¨çš„æ„å»ºç¼“å†²ï¼›
  - `on_sync.send(output_buffer.clone())`ï¼›
  - ä½ çœŸæ­£ä¼˜åŒ–çš„æ˜¯ï¼šå‡å°‘æ„å»ºè¿‡ç¨‹çš„åˆ†é…ï¼ˆè¿™ä¸ªèƒ½åšåˆ°ã€ä¸”ç¡®å®šæœ‰æ•ˆï¼‰ã€‚
  - ç„¶åç”¨åŸºå‡†æ•°æ®å†³å®š clone æ˜¯å¦çœŸçš„æ˜¯ 0.5~1ms çš„ç“¶é¢ˆï¼ˆå¾ˆå¤šæ—¶å€™ putImageData æ‰æ˜¯ï¼‰ã€‚

- **è·¯çº¿ Bï¼ˆé«˜çº§ï¼Œéœ€ç¡®è®¤ Tauri èƒ½åŠ›ï¼‰**ï¼šæ”¹æˆå‘é€ `SharedArrayBuffer` / shared memory / mmapï¼ˆå¦‚æœ Tauri v2 æœ‰å¯ç”¨æœºåˆ¶ï¼‰
  - è¿™æ˜¯å”¯ä¸€èƒ½â€œçœŸæ­£ä¸ clone ä¸”å¤ç”¨å†…å­˜â€çš„æ–¹å‘ï¼›
  - ä½†å¤æ‚åº¦æ˜æ˜¾æ›´é«˜ï¼Œåº”ä½œä¸º Phase 2+/Phase 3 æ–¹æ¡ˆã€‚

> ä½ ç°åœ¨çš„ v1.2 â€œåŒç¼“å†²â€å†™æ³•ï¼Œå»ºè®®åœ¨æ–‡æ¡£é‡Œé™çº§ä¸ºâ€œæ¢ç´¢é¡¹/å¾…éªŒè¯â€ï¼Œä¸è¦ä½œä¸ºå·²é‡‡çº³çš„å…³é”®ä¿®æ­£å†™å…¥æ€§èƒ½è¡¨ï¼ˆå¦åˆ™é¢„ä¼°ä¼šå¤±çœŸï¼‰ã€‚

---

### 2) ç›®å‰çš„â€œLRUâ€å…¶å®æ˜¯ FIFOï¼Œä¸æ˜¯ LRU

ä½ ç”¨ `VecDeque` åªåœ¨ `start` æ—¶ `push_back`ï¼Œæ·˜æ±°æ—¶ `pop_front`ï¼Œè¿™å«**æŒ‰åˆ›å»ºé¡ºåºæ·˜æ±°ï¼ˆFIFOï¼‰**ï¼Œä¸æ˜¯ LRUï¼ˆLeast Recently Usedï¼‰ã€‚

å¦‚æœä½ çœŸè¦ LRUï¼Œéœ€è¦åœ¨æ¯æ¬¡ `rust_brush_input` / `rust_brush_end` è§¦è¾¾ session æ—¶ï¼ŒæŠŠè¯¥ session åœ¨é˜Ÿåˆ—é‡Œç§»åŠ¨åˆ°é˜Ÿå°¾ï¼ˆæˆ–ç”¨ `lru` crate / HashMap+é“¾è¡¨ç»“æ„ï¼‰ã€‚

**å»ºè®®**ï¼š

- å¦‚æœä½ çš„ç›®æ ‡åªæ˜¯â€œé™åˆ¶ session æ•°é˜²æ³„éœ²â€ï¼ŒFIFO å¤Ÿç”¨ï¼Œæ–‡æ¡£åˆ«å« LRUï¼›
- å¦‚æœç¡®å®è¦ LRUï¼Œè¡¥ä¸Š access touch é€»è¾‘ï¼Œå¹¶è¯´æ˜é”é¡ºåºã€‚

---

### 3) ä¸¤æŠŠ Mutexï¼ˆengines / session_orderï¼‰å­˜åœ¨æ½œåœ¨æ­»é”é£é™©ï¼šéœ€è¦è§„å®šé”é¡ºåº

`rust_brush_start` é‡Œæ‹¿äº† `engines` é”åï¼Œå†å»é” `session_order`ï¼ˆå¹¶ä¸” `evict_oldest()` å†…ä¹Ÿé” `session_order`ï¼‰ã€‚åªè¦æœªæ¥æŸä¸ªè·¯å¾„åè¿‡æ¥ï¼ˆå…ˆé” order å†é” enginesï¼‰ï¼Œå°±ä¼šæ­»é”ã€‚

**å»ºè®®**ï¼š

- æ–‡æ¡£åŠ ä¸€æ¡â€œé”é¡ºåºè§„èŒƒï¼šæ°¸è¿œå…ˆé” session_orderï¼Œå†é” enginesâ€ï¼ˆæˆ–ç›¸åï¼Œä½†è¦ç»Ÿä¸€ï¼‰ï¼›
- æˆ–æ›´ç®€å•ï¼šæŠŠ `session_order` åˆå¹¶åˆ°åŒä¸€æŠŠ Mutex é‡Œï¼ˆä¸€ä¸ª struct ä¸€æŠŠé”ï¼‰ï¼Œé™ä½é£é™©ã€‚

---

## ä¸­ç­‰ä¼˜å…ˆçº§å»ºè®®ï¼ˆä¸æ”¹ä¹Ÿèƒ½åš MVPï¼Œä½†ä¼šå½±å“ä½“éªŒ/æ­£ç¡®æ€§ï¼‰

### 4) å‰ç«¯ pendingMessages ç›®å‰æµ‹ä¸åˆ°â€œç§¯å‹â€ï¼Œåªèƒ½æµ‹â€œé‡å…¥â€

ä½ è¿™é‡Œï¼š

```ts
this.channel.onmessage = (data) => {
  this.pendingMessages++;
  this.handleSync(data);
  this.pendingMessages--;
};
```

ç”±äº `handleSync` åŒæ­¥æ‰§è¡Œï¼Œ`pendingMessages` ç»å¤§å¤šæ•°æ—¶é—´åªä¼šåœ¨ 0/1 ä¹‹é—´æ³¢åŠ¨ï¼Œ**æ— æ³•åæ˜ æ¶ˆæ¯é˜Ÿåˆ—ç§¯å‹**ã€‚çœŸæ­£ç§¯å‹å‘ç”Ÿåœ¨ï¼šæ¶ˆæ¯åˆ°è¾¾é€Ÿåº¦ > ä¸»çº¿ç¨‹å¤„ç†é€Ÿåº¦ï¼Œä½† JS å›è°ƒä»æ˜¯ä¸²è¡Œæ‰§è¡Œã€‚

**å»ºè®®**ï¼ˆæœ€å°æ”¹åŠ¨ï¼‰ï¼š

- ç”¨ä¸€ä¸ª `receivedCount++`ï¼Œåœ¨ `requestAnimationFrame` é‡Œç»Ÿä¸€ drain ä¸€ä¸ªé˜Ÿåˆ—å¹¶ `putImageData`ï¼Œç”¨é˜Ÿåˆ—é•¿åº¦åˆ¤æ–­èƒŒå‹ï¼›
- æˆ–åœ¨ `handleSync` å†…æµ‹ `performance.now()` è€—æ—¶+æ»‘åŠ¨çª—å£ï¼Œè¶…è¿‡é˜ˆå€¼è§¦å‘èŠ‚æµã€‚

---

### 5) `dirty_rect_bytes_safe()` é‡Œ `(self.dirty_rect.right as u32)` æœ‰æº¢å‡ºé£é™©

å½“ `right` ä¸ºè´Ÿæ•°æ—¶ï¼Œ`as u32` ä¼šå˜æˆå·¨å¤§å€¼ï¼Œå† `min(self.width)` ä¼šå¾—åˆ° `self.width`ï¼Œå¯èƒ½æ©ç›– bugã€‚

ä½ åœ¨ `get_sync_data` é‡Œç”¨çš„å†™æ³•æ›´å®‰å…¨ï¼ˆå…ˆ max(0) å†è½¬ u32ï¼‰ã€‚å»ºè®®ä¸¤å¤„ç»Ÿä¸€æˆåŒä¸€ç§å®‰å…¨å†™æ³•ï¼š

```rust
let right = self.dirty_rect.right.max(0) as u32;
let right = right.min(self.width);
```

---

## ç½®ä¿¡åº¦æ›´æ–°

- æ–‡æ¡£æ•´ä½“æ–¹å‘ï¼šä¾ç„¶æ˜¯å¯¹çš„ã€‚
- ä½† v1.2 çš„â€œæ—  clone åŒç¼“å†²â€å±äºå…³é”®ç»“è®ºé”™è¯¯/è‡³å°‘æœªéªŒè¯ï¼Œä¼šå½±å“æ€§èƒ½é¢„ä¼°ä¸å®ç°å¤æ‚åº¦ã€‚

**å»ºè®®æŠŠç½®ä¿¡åº¦ä» 75% è°ƒæ•´ä¸º 70%**ï¼ˆç›´åˆ°ä½ ç”¨åŸºå‡†æµ‹è¯•è¯æ˜ï¼š1ï¼‰clone çœŸæ˜¯ç“¶é¢ˆï¼›2ï¼‰åœ¨ Tauri è¯­ä¹‰ä¸‹ç¡®å®èƒ½åšåˆ°å¤ç”¨å†…å­˜è€Œä¸é‡æ–°åˆ†é…ï¼‰ã€‚

---

## ä½ å¯ä»¥ç›´æ¥æ”¹æ–‡æ¡£çš„ä¸¤æ¡å…·ä½“æªè¾ï¼ˆå»ºè®®ï¼‰

1. æŠŠ â€œåŒç¼“å†²ï¼Œæ—  cloneâ€ æ”¹æˆï¼š

> è¾“å‡ºç¼“å†²é‡‡ç”¨å¤ç”¨ scratch buffer æ„å»ºï¼›æ˜¯å¦èƒ½åšåˆ°æ—  clone å–å†³äº Tauri Channel çš„æ‰€æœ‰æƒä¸åº•å±‚æ‹·è´æœºåˆ¶ï¼ŒPhase 0.5 ç”¨åŸºå‡†æµ‹è¯•éªŒè¯åå†³å®šæœ€ç»ˆæ–¹æ¡ˆã€‚

2. æŠŠ â€œLRU æ·˜æ±°â€ æ”¹æˆï¼š

> FIFOï¼ˆæŒ‰åˆ›å»ºé¡ºåºï¼‰æ·˜æ±°æœ€æ—§ä¼šè¯ï¼›å¦‚éœ€ä¸¥æ ¼ LRUï¼Œåœ¨ Phase 0.3 å¢åŠ  touch æ›´æ–°æœºåˆ¶æˆ–å¼•å…¥ lru crateã€‚

å¦‚æœä½ å¸Œæœ›æˆ‘ç»™å‡ºä¸€ç‰ˆâ€œåœ¨ä¸å¼•å…¥ shared memory çš„å‰æä¸‹ï¼Œæœ€åˆç†çš„ Rust è¾“å‡ºç¼“å†²å®ç°ä»£ç â€ï¼ˆå…¼é¡¾å°‘åˆ†é…ã€å¯è§£é‡Šçš„æ€§èƒ½ï¼‰ï¼Œæˆ‘å¯ä»¥ç›´æ¥æŒ‰ä½ çš„ `get_sync_data`/command ç»“æ„ç»™å‡ºå¯æ›¿æ¢çš„å®ç°ã€‚
