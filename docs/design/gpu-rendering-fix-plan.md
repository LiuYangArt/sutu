# GPU ç¬”åˆ·æ¸²æŸ“ä¿®å¤è®¡åˆ’

> **æ—¥æœŸ**: 2026-01-14
> **çŠ¶æ€**: è¿›è¡Œä¸­
> **ç›®æ ‡**: ä¿®å¤ GPU æ¸²æŸ“çš„è§†è§‰ä¸€è‡´æ€§é—®é¢˜ï¼Œæ¶ˆé™¤é—ªçƒ

---

## å½“å‰çŠ¶æ€

| ç›®æ ‡                           | çŠ¶æ€      | è¯´æ˜                        |
| ------------------------------ | --------- | --------------------------- |
| å¤§ç¬”åˆ·æ€§èƒ½æå‡                 | âœ… å·²è¾¾æˆ | 500px+ ç¬”åˆ·æ€§èƒ½æ˜æ˜¾ä¼˜äº CPU |
| è§†è§‰æ•ˆæœä¸ CPU ä¸€è‡´            | âŒ æœªè¾¾æˆ | ç®—æ³•å·®å¼‚å¯¼è‡´è§†è§‰ç¼ºé™·        |
| WYSIWYGï¼ˆPreview = Compositeï¼‰ | âŒ æœªè¾¾æˆ | æŠ¬ç¬”æ—¶æœ‰é—ªçƒ                |

---

## é—®é¢˜åˆ—è¡¨

### P0: Shader ç®—æ³•ä¸ä¸€è‡´

| é—®é¢˜               | ç°è±¡                 | æ ¹å›                           | ä¿®å¤æ–¹æ¡ˆ                |
| ------------------ | -------------------- | ----------------------------- | ----------------------- |
| Gaussian æ›²çº¿é”™è¯¯  | è½¯ç¬”åˆ·è¾¹ç¼˜è¿‡æ¸¡ä¸æŸ”å’Œ | `distfactor` ç¼ºå°‘ `/dab_size` | ä¿®æ­£å…¬å¼                |
| ç™½è‰²è¾¹ç¼˜çº¿         | å¿«é€Ÿç»˜ç”»æ—¶å‡ºç°ç™½è¾¹   | é¢„ä¹˜ Alpha å¤„ç†ä¸å½“           | ä¸¥æ ¼é¢„ä¹˜é€»è¾‘ + å®ˆå«ä»£ç  |
| hardness=100 æ¸å˜  | è¾¹ç¼˜åº”çº¯è‰²å´æœ‰æ¸å˜   | AA å¸¦ç”¨å½’ä¸€åŒ–è·ç¦»             | æ”¹ç”¨ç‰©ç†åƒç´ è®¡ç®—        |
| **é¢œè‰²ç©ºé—´ä¸ä¸€è‡´** | æ·±è‰²æ··åˆç»“æœå·®å¼‚     | CPU=sRGB, GPU=Linear          | å¼ºåˆ¶ sRGB ç©ºé—´æ··åˆ      |

### P0: ğŸš¨ GPU Instancing ç ´å Alpha Darken ç´¯ç§¯ï¼ˆæ–°å‘ç°ï¼‰

> [!CAUTION]
> è¿™æ˜¯æ ¹æœ¬æ€§æ¶æ„é—®é¢˜ï¼Œä¸æ˜¯ç®€å•çš„å‚æ•°ä¿®å¤ï¼

| é—®é¢˜              | ç°è±¡                      | æ ¹å›                                 |
| ----------------- | ------------------------- | ----------------------------------- |
| **Flow å‚æ•°æ— æ•ˆ** | ä½ Flow æ—¶ GPU ä»æ˜¾ç¤ºçº¯è‰² | æ‰€æœ‰ dab åŒæ—¶æ¸²æŸ“ï¼Œæ— æ³•è¯»å–ç´¯ç§¯ç»“æœ |

**é—®é¢˜åˆ†æï¼š**

```
CPU å·¥ä½œæ–¹å¼ (æ­£ç¡®):
  dab1 â†’ æ›´æ–° buffer â†’ dab2 è¯»å–æ›´æ–°åçš„ dst_a â†’ ç´¯ç§¯ â†’ dab3...
  æ¯ä¸ª dab èƒ½çœ‹åˆ°ä¹‹å‰ dab çš„ç»“æœï¼ŒAlpha Darken ç´¯ç§¯æ­£å¸¸

GPU å½“å‰å·¥ä½œæ–¹å¼ (é”™è¯¯):
  [dab1, dab2, dab3, dab4, dab5] â†’ åŒä¸€ä¸ª render pass
                                â†’ å…¨éƒ¨ä»åŒä¸€ä¸ªæºçº¹ç†è¯»å–
                                â†’ dst_a å…¨æ˜¯ 0 (ä¹‹å‰çŠ¶æ€)
                                â†’ æ¯ä¸ª dab éƒ½è®¤ä¸ºæ˜¯ç¬¬ä¸€æ¬¡ç»˜åˆ¶
                                â†’ Alpha Darken ç´¯ç§¯å¤±æ•ˆ
```

**è§£å†³æ–¹æ¡ˆé€‰é¡¹ï¼š**

1. **Compute Shader æ–¹æ¡ˆ** (æ¨è)
   - é¡ºåºå¤„ç†æ¯ä¸ª dab (atomic æˆ–å¾ªç¯)
   - å¯å®ç°æ­£ç¡®çš„ Read-Modify-Write
   - éœ€é‡å†™æ ¸å¿ƒæ¸²æŸ“é€»è¾‘

2. **å¤š Pass æ–¹æ¡ˆ**
   - æ¯ä¸ª dab å•ç‹¬ä¸€ä¸ª render pass
   - æ¯æ¬¡è¯»å–ä¸Šä¸€å¸§ç»“æœ
   - æ­£ç¡®ä½†æ€§èƒ½è¾ƒå·®

3. **é¢„è®¡ç®—ç´¯ç§¯è¡¨**
   - åœ¨ CPU é¢„è®¡ç®—é‡å åŒºåŸŸçš„æœ€ç»ˆ alpha
   - ä¸€æ¬¡æ€§æ¸²æŸ“æœ€ç»ˆçŠ¶æ€
   - é€‚åˆé«˜é‡å åœºæ™¯ï¼Œå¤æ‚åº¦è¾ƒé«˜

### P1: Preview/Composite æ•°æ®æµä¸ä¸€è‡´

| é—®é¢˜     | ç°è±¡               | æ ¹å›                                      |
| -------- | ------------------ | ---------------------------------------- |
| æŠ¬ç¬”é—ªçƒ | ç”»å®Œä¸€ç¬”æ—¶ç”»é¢é—ªçƒ | Preview/Composite ä½¿ç”¨ä¸åŒ readback æ—¶æœº |

---

## ä¿®å¤è®¡åˆ’

### Phase 0: æµ‹è¯•ç¯å¢ƒ + GPU/CPU åˆ‡æ¢åŠŸèƒ½

> [!IMPORTANT]
> å…ˆæœ‰æµ‹è¯•ï¼Œåæœ‰ä¿®å¤ã€‚GPU/CPU åˆ‡æ¢åŠŸèƒ½æ—¢æ˜¯å¼€å‘å·¥å…·ï¼Œä¹Ÿæ˜¯ç”¨æˆ·åŠŸèƒ½ã€‚

#### 0.1 GPU/CPU æ¸²æŸ“åˆ‡æ¢åŠŸèƒ½ (âœ… å·²å®Œæˆ)

**ç›®çš„**: æ–¹ä¾¿å¼€å‘æ—¶ç›´æ¥å¯¹æ¯” GPU/CPU æ¸²æŸ“æ•ˆæœï¼ŒåŒæ—¶ä½œä¸ºç”¨æˆ·åŠŸèƒ½æä¾›å›é€€é€‰é¡¹ã€‚

**å®ç°æ–¹æ¡ˆ**:

1. **Store æ‰©å±•** (`src/stores/tool.ts`): âœ…

   ```typescript
   // æ–°å¢çŠ¶æ€
   renderMode: 'gpu' | 'cpu';  // æ˜¾å¼é€‰æ‹©
   setRenderMode: (mode) => void;
   ```

2. **UI ç»„ä»¶** (`src/components/BrushPanel/`): âœ…
   - åœ¨ç¬”åˆ·è®¾ç½®é¢æ¿åº•éƒ¨æ·»åŠ åˆ‡æ¢å¼€å…³
   - ä¸¤ä¸ªé€‰é¡¹: GPU / CPU (ç§»é™¤ Auto æ¨¡å¼ä»¥æä¾›æ›´æ˜ç¡®æ§åˆ¶)
   - å¢åŠ äº†é¢æ¿é«˜åº¦ä»¥å®¹çº³æ–°é€‰é¡¹

3. **æ¸²æŸ“å±‚é›†æˆ** (`src/components/Canvas/`): âœ…
   - æ ¹æ® `renderMode` é€‰æ‹© `StrokeAccumulator` æˆ– `GPUStrokeAccumulator`
   - ç§»é™¤ `auto` æ¨¡å¼é€»è¾‘ï¼Œæ”¹ä¸ºç›´æ¥æ˜ å°„

#### 0.2 è§†è§‰å¯¹æ¯”æµ‹è¯•

| æ­¥éª¤            | è¯´æ˜                      | äº§å‡º                                                                                               |
| --------------- | ------------------------- | -------------------------------------------------------------------------------------------------- |
| åˆ›å»ºæµ‹è¯•é¡µé¢    | å¹¶æ’æ˜¾ç¤º GPU/CPU æ¸²æŸ“ç»“æœ | [gpu-cpu-comparison.html](file:///f:/CodeProjects/PaintBoard/tests/visual/gpu-cpu-comparison.html) |
| è®°å½•å·®å¼‚åŸºçº¿    | å½“å‰å„å‚æ•°çš„å·®å¼‚ç‡        | å·®å¼‚æŠ¥å‘Š                                                                                           |
| CI é›†æˆï¼ˆå¯é€‰ï¼‰ | Playwright è‡ªåŠ¨æˆªå›¾å¯¹æ¯”   | å›å½’æµ‹è¯•                                                                                           |

**æµ‹è¯•ç”¨ä¾‹**:

- ç¡¬åº¦: `hardness=0.0/0.5/1.0`
- å°ºå¯¸: `size=10/100/500`
- æµé‡: `flow=0.1/0.5/1.0`
- **æ··åˆæ¨¡å¼**: Normal / Multiply / Overlayï¼ˆå†³å®šæ˜¯å¦éœ€è¦ Grab Passï¼‰
- è¾¹ç•Œæ¡ä»¶: ç”»å¸ƒè¾¹ç¼˜è£å‰ª

---

### Phase 1: ä¿®å¤ Shader ç®—æ³•

#### 1.1 é¢œè‰²ç©ºé—´å¯¹é½ï¼ˆæå…¶å…³é”®ï¼ï¼‰

> [!CAUTION]
> Canvas 2D åœ¨ **Gamma ç¼–ç ç©ºé—´ï¼ˆéçº¿æ€§ sRGBï¼‰** ä¸­ç›´æ¥åšåŠ å‡ä¹˜é™¤ï¼Œè¿™åœ¨ç‰©ç†ä¸Šæ˜¯é”™çš„ï¼Œä½†å®ƒæ˜¯ Web æ ‡å‡†ã€‚

**æ•°å­¦ç©ºé—´é™·é˜±**ï¼š

- Canvas 2D: éçº¿æ€§ç©ºé—´åš `mix()`
- WebGPU `rgba16float`: é€šå¸¸è¢«è§†ä¸ºçº¿æ€§ç©ºé—´
- **ç»“æœ**: å³ä½¿ä¸¤ç«¯é¢œè‰²ä¸€æ ·ï¼Œä¸­é—´è¿‡æ¸¡è‰²ä¹Ÿä¼šä¸åŒï¼ˆGPU æ›´äº®ï¼‰

**å¼ºåˆ¶ä¸€è‡´æ–¹æ¡ˆ**:

1. è¾“å…¥ï¼šä¼ å…¥ Shader çš„é¢œè‰²ä¿æŒ sRGB å€¼ï¼ˆä¸è½¬ Linearï¼‰
2. è®¡ç®—ï¼šç›´æ¥å¯¹ sRGB å€¼åš Alpha Darken / Mix
3. è¾“å‡ºï¼šç›´æ¥è¾“å‡ºç»“æœ
4. æç«¯æ‰‹æ®µï¼šè‹¥é©±åŠ¨å¼ºåˆ¶çº¿æ€§åŒ–ï¼Œéœ€æ‰‹åŠ¨ `LinearToSRGB`/`SRGBToLinear` é€†å˜æ¢æŠµæ¶ˆ

```typescript
// WebGPU Canvas é…ç½®
canvas.getContext('webgpu', { colorSpace: 'srgb' });
```

#### 1.2 ä¿®å¤ `distfactor` è®¡ç®—

```diff
- let distfactor = (SQRT_2 * 12500.0) / (6761.0 * safe_fade);
+ let distfactor = (SQRT_2 * 12500.0) / (6761.0 * safe_fade * in.dab_size);
```

#### 1.3 ä½¿ç”¨ Storage Buffer æŸ¥è¡¨ï¼ˆæ›¿ä»£æ•°å­¦è¿‘ä¼¼ï¼‰

> [!TIP]
> ä¸ç”¨çº¹ç†é‡‡æ ·ï¼ˆæœ‰çº¿æ€§æ’å€¼è¯¯å·®ï¼‰ï¼Œç”¨ Storage Buffer å®Œå…¨å¤åˆ¶ CPU æŸ¥è¡¨é€»è¾‘ã€‚

```wgsl
@group(0) @binding(3) var<storage, read> gaussian_table: array<f32>; // 1024 ä¸ªå€¼

fn get_gaussian(dist: f32) -> f32 {
    let index = u32(clamp(dist, 0.0, 1.0) * 1023.0);
    return gaussian_table[index];
}
```

> [!WARNING]
> **ç´¢å¼•å¯¹é½é™·é˜±**: GPU `u32()` = `floor`ï¼Œè‹¥ CPU ç”¨ `Math.round`ï¼Œè¾¹ç•Œå€¼ä¼šæœ‰ 1 ç´¢å¼•åå·®ã€‚
>
> éœ€å¤æŸ¥ `maskCache.ts` çš„ç´¢å¼•é€»è¾‘ï¼š
>
> - CPU `Math.floor(val * 1023)` â†’ GPU `u32(val * 1023.0)`
> - CPU `Math.round(val * 1023)` â†’ GPU `u32(val * 1023.0 + 0.5)`

#### 1.4 é¢„ä¹˜ Alpha å®ˆå«ä»£ç 

> [!WARNING]
> æ°¸è¿œä¸è¦è¾“å‡º `rgb > a` çš„éæ³•é¢„ä¹˜å€¼ã€‚

```wgsl
// æ··åˆåå¼ºåˆ¶ä¿®æ­£
out.rgb = min(out.rgb, vec3(out.a));
```

**æ··åˆå…¬å¼ç¡®è®¤**:

```wgsl
// æ ‡å‡†é¢„ä¹˜æ··åˆï¼šTarget = Source + Dest * (1 - Source.a)
// æ³¨æ„ï¼šè¾“å…¥å·²é¢„ä¹˜ï¼Œä¸è¦å†ä¹˜ alphaï¼
```

#### 1.5 ä¿®å¤ AA å¸¦è®¡ç®—

```wgsl
let pixel_size = 1.0 / in.dab_size;
let half_pixel = pixel_size * 0.5;
```

---

### Phase 2: é‡æ„ Preview æ¶æ„

**æ–¹æ¡ˆ: WebGPU Overlay + Canvas 2D Underlay**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     WebGPU Canvas (é€æ˜ï¼Œé¡¶å±‚)          â”‚
â”‚     - æ˜¾ç¤ºå½“å‰ç¬”è§¦ï¼Œæ—  readback          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚     Canvas 2D (åº•å±‚)                    â”‚
â”‚     - æ˜¾ç¤ºå·²å®Œæˆå›¾å±‚                     â”‚
â”‚     - EndStroke æ—¶åˆæˆç¬”è§¦               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 2.1 Grab Pass æœºåˆ¶ï¼ˆæ”¯æŒå¤æ‚æ··åˆæ¨¡å¼ï¼‰

> [!IMPORTANT]
> Multiply ç­‰æ··åˆæ¨¡å¼éœ€è¦èƒŒæ™¯å‚ä¸ï¼Œå¦åˆ™ Preview å’Œ Composite ç»“æœä¸ä¸€è‡´ã€‚

**æµç¨‹**:

1. `PointerDown`: æ£€æµ‹æ··åˆæ¨¡å¼
   - Normal æ¨¡å¼ï¼šä¸éœ€è¦èƒŒæ™¯
   - å…¶ä»–æ¨¡å¼ï¼šæŠ“å–ç¬”åˆ·åŒ…å›´ç›’åŒºåŸŸåˆ° `bg_texture`
2. `PointerMove`: Shader ä¸­ `out = Blend(bg_texture, brush_color)`
3. `PointerUp`: å›è¯»å¹¶åˆæˆï¼ˆæˆ–è¦†ç›–ï¼‰

> [!CAUTION]
> **æ€§èƒ½é™·é˜±**: 4K ç”»å¸ƒä¸Šä¼ ä¼šå¯¼è‡´èµ·ç¬”å»¶è¿Ÿï¼

**è„çŸ©å½¢ä¼˜åŒ–**:

```typescript
// åªä¸Šä¼ ç¬”åˆ·åŒ…å›´ç›’åŒºåŸŸï¼Œè€Œéæ•´ä¸ª Canvas
const imageData = ctx.getImageData(x, y, w, h); // åªè·å–åŒ…å›´ç›’
device.queue.writeTexture(
  { texture: bgTexture, origin: { x, y } }, // æŒ‡å®š offset
  imageData.data,
  { bytesPerRow: w * 4 },
  { width: w, height: h }
);
```

**æ”¶ç›Š**: æ™®é€šç¬”è§¦çš„æ•°æ®é‡å‡å°‘ 99%ï¼Œæ¶ˆé™¤èµ·ç¬”å»¶è¿Ÿã€‚

---

### Phase 3: éªŒè¯

#### 3.1 Shader å•å…ƒæµ‹è¯•ï¼ˆæ¨èï¼‰

> [!TIP]
> ä¸æ¸²æŸ“åƒç´ ï¼Œå…ˆéªŒè¯æ•°å­¦å…¬å¼ã€‚æ¯”çœ‹å›¾æ‰¾èŒ¬æ›´å¿«æ›´ç²¾å‡†ã€‚

```typescript
// Compute Shader æµ‹è¯•ï¼šè¾“å…¥ (dist, size, hardness)ï¼Œè¾“å‡ºè®¡ç®—ç»“æœ
// JS è¯»å– Bufferï¼Œä¸ CPU maskCache å‡½æ•°è¿”å›å€¼å¯¹æ¯”
expect(gpuResult).toBeCloseTo(cpuResult, 5); // 5 ä½ç²¾åº¦
```

#### 3.2 éªŒè¯æ ‡å‡†

| æµ‹è¯•é¡¹     | æ–¹æ³•                   | é€šè¿‡æ ‡å‡†   |
| ---------- | ---------------------- | ---------- |
| åƒç´ ä¸€è‡´æ€§ | GPU vs CPU å• dab å¯¹æ¯” | è¯¯å·® â‰¤ Â±2  |
| WYSIWYG    | Preview ä¸æŠ¬ç¬”åå¯¹æ¯”   | å®Œå…¨ä¸€è‡´   |
| æ€§èƒ½       | å¤§ç¬”åˆ· benchmark       | ä¼˜äº CPU   |
| æ··åˆæ¨¡å¼   | Multiply/Overlay æµ‹è¯•  | æ— è§†è§‰è·³å˜ |

---

## æ‰§è¡Œä¼˜å…ˆçº§

1. **ç«‹å³**:
   - Phase 0.1: GPU/CPU åˆ‡æ¢åŠŸèƒ½ï¼ˆâœ… å·²å®Œæˆï¼‰
   - Phase 0.2: è§†è§‰å¯¹æ¯”æµ‹è¯•ï¼ˆâœ… å·²å®Œæˆï¼Œè§ [gpu-cpu-comparison.html](file:///f:/CodeProjects/PaintBoard/tests/visual/gpu-cpu-comparison.html)ï¼‰
2. **ç´§æ€¥ï¼ˆé˜»å¡å…¶ä»–ä¿®å¤ï¼‰**:
   - **è§£å†³ GPU Instancing ç´¯ç§¯é—®é¢˜** - è¿™æ˜¯æœ€å…³é”®çš„æ¶æ„é—®é¢˜ï¼Œä¸è§£å†³å…¶ä»– shader ä¿®å¤éƒ½æ²¡æœ‰æ„ä¹‰
   - æ¨èæ–¹æ¡ˆï¼šCompute Shader æˆ– å¤š Pass
3. **çŸ­æœŸ**:
   - Phase 1.1: é¢œè‰²ç©ºé—´å¯¹é½
   - Phase 1.2-1.5: Shader ä¿®å¤
4. **ä¸­æœŸ**:
   - Phase 2: Overlay æ¶æ„ + Grab Pass
5. **æŒç»­**:
   - Phase 3: éªŒè¯ + CI é›†æˆ

> [!CAUTION]
> **ä¸è¦æ€¥äºè¿½æ±‚æ€§èƒ½æŒ‡æ ‡ï¼Œå…ˆæ­»ç£•"åƒç´ ä¸€è‡´æ€§"**ã€‚

---

## å‚è€ƒæ–‡ä»¶

| æ–‡ä»¶                                                                                                              | è¯´æ˜                     |
| ----------------------------------------------------------------------------------------------------------------- | ------------------------ |
| [maskCache.ts](file:///f:/CodeProjects/PaintBoard/src/utils/maskCache.ts)                                         | CPU ç‰ˆ Gaussian mask     |
| [strokeBuffer.ts](file:///f:/CodeProjects/PaintBoard/src/utils/strokeBuffer.ts)                                   | CPU ç‰ˆ StrokeAccumulator |
| [brush.wgsl](file:///f:/CodeProjects/PaintBoard/src/gpu/shaders/brush.wgsl)                                       | GPU shaderï¼ˆéœ€ä¿®å¤ï¼‰     |
| [tool.ts](file:///f:/CodeProjects/PaintBoard/src/stores/tool.ts)                                                  | å·¥å…·çŠ¶æ€ç®¡ç†             |
| [gpu-brush-rendering-issues.md](file:///f:/CodeProjects/PaintBoard/docs/postmortem/gpu-brush-rendering-issues.md) | é—®é¢˜è¯¦ç»†åˆ†æ             |
