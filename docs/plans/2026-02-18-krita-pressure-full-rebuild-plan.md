# 画笔压感全链路重构计划（仅文档版，不改代码）

目标：我只接受“画一笔结果与 Krita 一致”。
完成定义：

1. 用 Krita 冻结基线对比（不是自生成基线）。
2. slow_lift / fast_flick / abrupt_stop / low_pressure_drag 等场景全部 pass。
3. 我手测同一笔划，宽度变化和收尾体感与 Krita 无明显差异。
   不接受：
4. 只说“计划已落地”。
5. 只给代码完成，不给达标结论。
   输出要求：
   先给一句“是否达标：是/否”，再给差距和下一步。

## 1. 目标与边界

### 1.1 本轮目标

1. 形成可直接执行的压感系统全链路重构计划文档。
2. 明确验证策略采用“双重严格门禁”：
   1. 中间各阶段计算一致。
   2. 最终画面结果一致。
3. 默认不改 Krita 源码。

### 1.2 本轮不做

1. 不修改 `src/`、`src-tauri/`、`scripts/` 任何代码。
2. 不修改 Krita 仓库源码。
3. 不引入新的运行脚本实现（只定义后续应实现内容）。

---

## 2. 核心结论（先回答关键问题）

### 2.1 一定要改 Krita 源码吗

不是必须。
本计划默认采用“冻结 Krita 基线资产 + 自动回放对比”的验证方式，不依赖对 Krita 源码插桩。

### 2.2 每阶段做对了，输入输出是否应一致

理论上是。
但要成立，必须同时满足以下口径一致：

1. 时间戳来源与单位一致（ms/us、取整策略）。
2. 浮点计算精度与截断策略一致。
3. 边界行为一致（首点、末点、零压附近、突变点）。
4. 采样触发顺序一致（distance/time 的优先规则）。

本计划会把以上项全部写成可验证条目。

---

## 3. 交付文档清单

1. `docs/plans/2026-02-18-krita-pressure-full-rebuild-plan.md`（本文件）
2. `docs/testing/krita-pressure-full-gate-spec.md`（门禁规范）
3. `docs/testing/krita-pressure-full-test-cases.md`（测试用例）

---

## 4. 实施阶段计划（后续代码阶段执行）

## Phase 0：冻结唯一口径

目标：先锁死比较口径，避免“边做边变标准”。

产物：

1. 固定输入：`C:\Users\LiuYang\AppData\Roaming\com.sutu\debug-data\debug-stroke-capture.json`
2. 固定画布参数：尺寸、DPI、背景、缩放。
3. 固定笔刷参数：最小可复现集合（size/spacing/flow/opacity/hardness + 压感相关项）。
4. 固定导出结构：阶段结果、最终结果、高速窗口统计。

通过标准：

1. 同一输入重复运行 10 次，输出结构完全一致。
2. 任一缺失字段或新增未登记字段，直接判失败。

## Phase 1：阶段规则化（中间每一步）

目标：把研究文档中的链路拆成可核验规则。

固定 6 段：

1. 输入样本标准化
2. 全局压感曲线映射
3. 速度估计
4. 采样触发与 carry
5. 线性插值（mix）
6. 动态传感器映射（pressure/speed -> size/flow/opacity）

每段都必须定义：

1. 输入字段
2. 输出字段
3. 边界条件
4. 判定公式
5. 通过标准

## Phase 2：结果规则化（最终画面）

目标：把“看起来像”改为可量化指标。

固定比较项：

1. 笔迹宽度曲线一致性
2. 尾段衰减曲线一致性
3. 像素差异（全图与 ROI）

通过标准：

1. 三类结果指标全部达标，才算阶段通过。

## Phase 3：不改 Krita 源码的验证方案

目标：在不改 Krita 源码前提下实现稳定验证。

策略：

1. 冻结 Krita 基线资产（按固定输入录制得到的参考产物）。
2. Sutu 每次重构后自动回放同一输入，输出同结构结果。
3. 自动对比 Sutu 输出与 Krita 冻结基线资产。
4. 基线升级采用受控流程：新版本 Krita 重新生成并审计后替换。

说明：

1. 该方案可满足持续验证需求。
2. 若未来需要“内部中间态逐点一一比对”，再考虑 Krita 插桩方案（非本计划默认路径）。

## Phase 4：高速高样本门禁

目标：避免“单次快划偶然过线”导致误判。

策略：

1. 对高速度段按窗口统计，不看单点。
2. 设最小窗口数量门槛；样本不足直接判失败。
3. 输出 p50/p95/p99 与失败窗口清单。

通过标准：

1. 高速窗口门禁全部通过，且无“样本不足”。

---

## 5. 重要接口/类型改造方向（计划声明）

说明：以下为后续代码阶段改造方向，本轮不执行。

1. 输入链路移除 fallback 语义字段和分支。
2. 压感主链统一到单核心模块，不再并行旧启发式路径。
3. 设置项迁移为 Krita 语义命名并清理旧字段。
4. 验收产物统一 schema：阶段结果 + 最终结果 + 高速统计。

---

## 6. 验收判定规则（总则）

1. 双重门禁均通过，才判定“与 Krita 一致”：
   1. 阶段门禁通过。
   2. 最终结果门禁通过。
2. 任一门禁失败，结论即为“不一致”。

---

## 7. 风险与对策

1. 风险：冻结基线过旧导致误判。
   - 对策：定义基线版本号与升级流程，升级必须附带回归报告。
2. 风险：只看最终图可能掩盖中间错误。
   - 对策：阶段门禁与最终门禁同时阻塞。
3. 风险：快划样本不够造成“伪通过”。
   - 对策：高速窗口最小样本门槛 + 样本不足即失败。

---

## 8. 默认假设与固定值

1. 默认不改 Krita 源码。
2. 默认输入文件固定为：
   - `C:\Users\LiuYang\AppData\Roaming\com.sutu\debug-data\debug-stroke-capture.json`
3. 默认执行“双重严格门禁”。
4. 默认结论规则：
   - 双门禁通过 = 一致
   - 任一失败 = 不一致

---

## 9. 参考

1. `docs/research/2026-02-18-krita-wacom-pressure-full-chain.md`
2. `docs/research/2026-02-18-krita-wacom-pressure-one-page.md`
