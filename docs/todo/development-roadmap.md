# PaintBoard 开发路线图

> 版本: 0.2.1 | 更新日期: 2026-01-16 | 创建日期: 2026-01-11

## 项目概览

本文档规划 PaintBoard 从脚手架到可用产品的完整开发路径。采用**渐进式开发**策略，优先实现核心绘画功能，逐步完善专业特性。

---

## 里程碑总览

| 里程碑             | 目标                     | 预估工作量 |
| ------------------ | ------------------------ | ---------- |
| **M0: 数位板输入** | WinTab 原生支持 (Wacom)  | ★★★☆☆      |
| **M1: 基础绘画**   | 能在画布上画出压感笔迹   | ★★☆☆☆      |
| **M2: 图层系统**   | 多图层 + 混合模式        | ★★★☆☆      |
| **M3: 笔刷系统**   | 可调节笔刷 + 预设        | ★★★☆☆      |
| **M4: 选区工具**   | 套索 + 矩形选区          | ★★★☆☆      |
| **M5: 文件系统**   | 保存/加载 + PSD 导入导出 | ★★★★☆      |
| **M6: 专业特性**   | 颜色混合 + 性能优化      | ★★★★★      |
| **M7: UI 框架**    | 悬浮面板 + Docking 系统  | ★★★☆☆      |

---

## M0: 数位板输入 (Tablet Input) ✅ 已完成

**目标**: 实现 WinTab 原生支持，为 Wacom 等专业数位板提供低延迟输入

### 技术背景

| API              | 优势                                   | 劣势                 |
| ---------------- | -------------------------------------- | -------------------- |
| **WinTab**       | Wacom 驱动优化，延迟最低，专业软件标准 | 专有 API，需驱动支持 |
| **Windows Ink**  | 系统原生，兼容性广                     | Wacom 设备延迟较高   |
| **PointerEvent** | 当前方案，前端实现简单                 | 依赖浏览器，无法优化 |

### 决策

- ✅ 优先实现 **WinTab** 后端（Wacom 用户体验最佳）
- ⏸️ 暂不集成 `octotablet`（仅支持 Windows Ink，不符合需求）
- ✅ 保留 PointerEvent 作为降级方案

### 库选择

- `wintab_lite`: 提供 WinTab API 绑定

### 任务清单

#### 0.1 WinTab 后端实现

- [x] 添加 `wintab_lite` 依赖
- [x] 实现 WinTab 上下文创建和设备连接
- [x] 实现压感/倾斜数据采集
- [x] 添加高频输入处理（> 200Hz）
- [x] 实现输入预测减少感知延迟
- [x] 处理 WinTab 驱动不存在的降级（回退到 PointerEvent）

#### 0.2 Rust 输入管线

- [x] 设计 `TabletBackend` trait 统一接口
- [x] 实现 `WinTabBackend`
- [x] 实现 `PointerEventBackend`（当前方案封装）
- [x] Tauri 事件通道：Rust → 前端

#### 0.3 设置 UI

- [x] 添加"数位板设置"面板
- [x] 数位板 API 选择（WinTab / PointerEvent）- 通过后端自动选择
- [x] 当前连接设备信息显示
- [x] 压感测试区域（实时显示压感值）
- [ ] 设置持久化到本地配置

### 验收标准

- ✓ Wacom 数位板通过 WinTab 正常工作
- ✓ 压感和倾斜数据正确采集
- ✓ 输入延迟 < 12ms（目标）
- ✓ 无 WinTab 驱动时自动降级到 PointerEvent

---

## M1: 基础绘画 (Foundation) ✅ 已完成

**目标**: 在画布上实现基本的压感绘画功能

> [!NOTE]
> 核心绘画功能已完成，放大镜工具双击重置功能作为低优先级遗留项

### 任务清单

#### 1.1 画布渲染基础

- [x] 实现 Canvas 2D 基础渲染（当前已有骨架）
- [x] 添加 `desynchronized: true` 减少延迟
- [x] 实现画布缩放/平移（鼠标滚轮 + 空格拖拽）
- [x] 添加画布背景网格（透明度指示）

#### 1.2 压感输入集成

- [x] 验证 PointerEvent 压感在 Tauri WebView 中的表现
- [x] 实现基础压感 → 笔刷大小映射
- [x] 实现压感 → 不透明度映射
- [x] 添加压感曲线调节（线性/软/硬/S曲线）

#### 1.3 笔迹平滑

- [x] 实现 Catmull-Rom 样条插值
- [x] 添加点位过滤（去除抖动）
- [x] 实现笔迹起始/结束渐变

#### 1.4 基础 UI

- [x] 颜色选择器（前景色/背景色）
- [x] 笔刷大小滑块
- [x] 不透明度滑块
- [x] 撤销/重做按钮 (Ctrl+Z/Ctrl+Y)

#### 1.5 基础绘图工具与快捷键 ✅ 已完成

> 这些功能对基础绘图体验至关重要，从后续里程碑前置到此处
> 快捷键设置都保存到本地 .json 配置文件中，后续开发快捷键管理器时可以使用

- [x] 笔刷大小快捷键 `[` `]`（原 M6.6）
- [x] Alt 按住取色（原 M6.1 取色器工具）
- [x] 橡皮擦工具 - 擦除到透明（原 M3.5）
- [x] 撤销/反撤销快捷键 `Ctrl+Z` / `Ctrl+Shift+Z`
- [x] 清除图层内容按钮
- [x] B/E 快捷键切换笔刷/橡皮擦
- [x] 笔刷和橡皮擦独立大小设置
- [x] 笔刷大小圆圈光标指示

#### 1.6 放大镜工具 (Zoom Tool) ✅ 已完成

- [x] 快捷键 `Z` 切换/暂时激活
- [x] 交互：按住鼠标左键往右拖拽放大，往左拖拽缩小 (Scrubby Zoom)
- [x] 工具栏添加放大镜图标
- [ ] 双击工具栏放大镜，reset zoom to 100% (低优先级)

### 验收标准

- ✓ 能用数位板画出平滑、有压感变化的笔迹
- ✓ 笔迹无明显延迟（< 50ms 可感知）
- ✓ 支持缩放和平移画布
- ✓ `[` `]` 可调节笔刷大小
- ✓ Alt 按住可临时取色
- ✓ 橡皮擦工具可擦除内容
- ✓ `Ctrl+Z` 撤销 / `Ctrl+Shift+Z` 反撤销
- ✓ 可一键清除当前图层内容
- ✓ 放大镜工具支持拖拽缩放 (Z键)

---

## M2: 图层系统 (Layers) ✅ 已完成

**目标**: 实现多图层绘画和基础图层操作

### 任务清单

#### 2.1 图层数据结构

- [x] 完善 Zustand document store 图层管理
- [ ] 实现图层树结构（支持图层组）- 移至 M7
- [x] 添加图层 ID 生成和管理

#### 2.2 图层渲染

- [x] 每图层独立 Canvas/纹理
- [x] 实现图层合成渲染管线
- [x] 添加图层可见性控制
- [x] 实现图层不透明度

#### 2.3 混合模式

- [x] 实现基础混合模式:
  - [x] Normal（正常）
  - [x] Multiply（正片叠底）
  - [x] Screen（滤色）
  - [x] Overlay（叠加）
- [x] 扩展混合模式:
  - [x] Darken / Lighten
  - [x] Color Dodge / Color Burn
  - [x] Soft Light / Hard Light
  - [x] Difference / Exclusion
  - [x] Hue / Saturation / Color / Luminosity

#### 2.4 图层面板 UI

- [x] 图层列表显示（缩略图 + 名称）
- [x] 图层缩略图显示实际图层效果
- [x] background 图层优化：不可被擦除 alpha，保留背景色
- [x] 拖拽排序
- [x] 可见性切换按钮（眼睛图标）
- [x] 锁定按钮
- [x] 不透明度滑块
- [x] 混合模式下拉选择
- [x] 右键菜单（删除、复制）

### 验收标准

- ✓ 能创建、删除、重排图层
- ✓ 不同图层的绘画相互独立
- ✓ 混合模式效果正确

---

## M3: 笔刷系统 (Brushes) 🚧 进行中

**目标**: 实现兼容 Photoshop ABR 的专业笔刷系统，优先保证手感。
参考设计：`docs/design/m3-brush-system.md` (Index)
参考文件：`@abr/tahraart.abr`

> [!NOTE]
> Phase 1-2 核心功能已完成，ABR 解析器已实现，笔刷预设 UI 基础版已完成

### 渲染后端策略

> **GPU 优先，CPU 降级**
>
> 笔刷渲染以 GPU (WebGPU) 为主要实现：
>
> | 笔刷类型 | GPU 实现 | CPU 降级 |
> |----------|----------|----------|
> | 参数化笔刷 | `GPUStrokeAccumulator` + `brush.wgsl` | `strokeBuffer.ts` + `maskCache.ts` |
> | 采样笔刷 | 扩展 GPU 管线，添加纹理图集采样 | 最小实现，仅保证可用 |
>
> CPU 实现仅作为 WebGPU 不可用时的降级方案，不追求功能对等。
> 新功能（如采样笔刷）优先在 GPU 实现，CPU 按需补充。

### 任务清单

#### 3.1 核心渲染管线 (Phase 1) ✅ 已完成

> 手感正确性核心， Flow/Opacity 分离
> 详见：[`docs/design/brush-system/01_rendering_pipeline.md`](../../design/brush-system/01_rendering_pipeline.md)

- [x] 实现输入平滑 (Catmull-Rom / Bezier)
- [x] 实现距离累积盖印算法
- [x] 建立 Flow/Opacity 三级渲染管线 (Dab -> Stroke Buffer -> Layer)
- [x] UI 界面，brush size/flow/opacity 各自有独立的slider。 slider旁边有单独的压感overide开关，开启后此参数必受压感影响。
<!-- - [ ] 实现基础混合模式 (Normal, Multiply) -->

#### 3.2 笔刷引擎扩展 (Phase 2) ✅ 基本完成

> 详见：[`docs/design/brush-system/02_brush_engine.md`](../../design/brush-system/02_brush_engine.md)

- [x] 先要有一个单独的笔刷参数设置面板，承载这些笔刷设置。
- [x] 持久化笔刷参数设置到本地 json 文件
- [x] 实现参数化圆形笔刷生成 (硬度/圆度/角度)
- [ ] 支持采样笔刷 (Sampled Brush Tip)
- [x] 实现动态参数系统 (压感/倾斜 -> 大小/透明度) - 基础版已实现
- [ ] 纹理缓存系统

#### 3.3 ABR 解析与兼容 (Phase 3) ✅ 已完成

> 详见：[`docs/design/brush-system/03_abr_parser.md`](../../design/brush-system/03_abr_parser.md)

- [x] 移植 psd-tools/Krita 解析逻辑
- [ ] 实现递归 ActionDescriptor 解析 (低优先级)
- [x] 建立默认值回退机制 (Fault Tolerance)
- [x] 实现 8BIMsamp 纹理提取与归一化
- [x] 编写 ABR 导入器 (Tauri Command)

#### 3.4 笔刷预设 UI (Phase 4) ✅ 基础版完成

> 详见：[`docs/design/brush-system/04_ui_ux.md`](../../design/brush-system/04_ui_ux.md)

- [x] 笔刷面板框架
- [x] 预设网格展示 (缩略图)
- [ ] 详细参数编辑器 (展开式)
- [x] 导入 ABR 对话框

#### 3.5 性能与高级特性 (Phase 5/6)

> 详见：[`docs/design/brush-system/01_rendering_pipeline.md`](../../design/brush-system/01_rendering_pipeline.md) (Phase 5) & [`docs/design/brush-system/05_advanced_features.md`](../../design/brush-system/05_advanced_features.md) (Phase 6)

- [ ] GPU Instancing 批量渲染优化
- [ ] Texture Arrays 纹理图集管理
- [ ] 瓦片化渲染支持 (Tiled Rendering)
- [ ] 双重画笔 (Dual Brush) - Virtual Masking 优化
- [ ] 湿边效果 (Wet Edges) - LUT 实现

### 验收标准

- ✓ 能够正确解析并导入常用 ABR 文件
- ✓ Flow/Opacity 表现与 Photoshop 一致 (关键手感指标)
- ✓ 高分辨率画布下笔刷绘制流畅 (GPU 加速)
- ✓ 支持双重画笔等高级效果

---

## M4: 选区工具 (Selection)

**目标**: 实现 Photoshop 风格的选区系统

### 任务清单

#### 4.1 选区数据结构

- [ ] 选区蒙版表示（位图或路径）
- [ ] 选区布尔运算（加、减、交）
- [ ] 选区边界计算

#### 4.2 选区工具

- [ ] 矩形选框工具
- [ ] 椭圆选框工具
- [ ] 套索工具lasso（自由选择freehand mode,按住alt切换polygonal选择方式 ）
- [ ] 多边形套索
- [ ] 魔棒工具（颜色选择）

#### 4.3 选区操作

- [ ] 全选 / 取消选择 / 反选
- [ ] 羽化
- [ ] 扩展 / 收缩
- [ ] 选区变换（移动、缩放）

#### 4.4 选区渲染

- [ ] 蚂蚁线动画边框
- [ ] 选区蒙版叠加显示
- [ ] 选区内限制绘画

### 验收标准

- ✓ 能创建矩形、椭圆、自由选区
- ✓ 选区内绘画正确受限
- ✓ 支持选区布尔运算

---

## M5: 文件系统 (File I/O)

**目标**: 实现项目保存和常见格式导入导出

### 任务清单

#### 5.1 原生项目格式 (.pbp)

- [ ] 设计项目文件结构
- [ ] 实现保存功能
- [ ] 实现加载功能
- [ ] 添加版本兼容性检查

#### 5.2 自动保存

- [ ] 定时自动保存（可配置间隔）
- [ ] 增量保存（仅保存变化）
- [ ] 崩溃恢复机制

#### 5.3 图片导出

- [ ] PNG 导出（支持透明）
- [ ] JPEG 导出（质量可调）
- [ ] 导出选项对话框

#### 5.4 PSD 支持

- [ ] PSD 读取（基础图层结构）
- [ ] PSD 导出（基础图层结构）
- [ ] 处理不支持的 PSD 特性警告

#### 5.5 文件对话框

- [ ] 新建文档对话框（尺寸、DPI）
- [ ] 打开文件对话框
- [ ] 保存/另存为对话框
- [ ] 导出对话框

### 验收标准

- ✓ 能保存和加载项目，所有图层状态保留
- ✓ 能导出 PNG/JPEG
- ✓ 能读取简单的 PSD 文件

---

## M6: 专业特性 (Advanced)

**目标**: 添加专业绘画软件特性，优化性能

### 任务清单

#### 6.1 颜色系统增强

- [ ] HSV/HSL 色盘
- [ ] 色板/色卡管理
- [x] 取色器工具（Alt 取色）→ 基础版已前置到 M1.5
- [ ] 取色器增强（取色预览、采样范围）
- [ ] 颜色历史记录

#### 6.2 颜色混合模式

- [ ] PS 式颜色混合（数字混合）
- [ ] 颜料式颜色混合（物理模拟）
- [ ] 混合模式切换

#### 6.3 历史记录

- [ ] 撤销/重做堆栈（可配置深度）
- [ ] 历史记录面板
- [ ] 快照功能

#### 6.4 性能优化

- [x] 迁移到 WebGPU 渲染 (GPU 笔刷引擎已实现)
- [x] 输入延迟优化:
  - [x] `desynchronized` canvas
  - [x] `pointerrawupdate` 低延迟输入 (Q1)
  - [x] 硬件光标支持 ≤128px (Q2)
  - [x] GPU Timestamp Query 性能剖析 (Q3)
  - [x] 批量处理 RAF 循环 + inputQueue
  - [x] 动态降采样 (Q4)
  - [x] Dirty Rect 局部合成 (M2)
- [ ] 大画布分块渲染（Tile-based）
- [ ] 图层缓存优化
- [ ] 内存使用监控

#### 6.5 Rust 输入管线

- [x] WinTab 后端实现 (wintab_backend.rs)
- [ ] 集成 octotablet 直接采集
- [x] 输入预测（减少感知延迟）→ 已在 M0 实现
- [x] 高频输入处理（> 200Hz）→ 已在 M0 实现

#### 6.6 快捷键系统

- [ ] 快捷键管理核心:
  - [ ] 快捷键注册与分发系统
  - [ ] 快捷键冲突检测
  - [ ] 快捷键上下文（全局/工具/面板）
- [ ] 内置快捷键:
  - [ ] 工具切换快捷键
  - [x] 笔刷大小 `[` `]` 快捷调节 → 已前置到 M1.5
  - [x] 撤销/重做 (Ctrl+Z / Ctrl+Shift+Z)
  - [ ] 保存/导出 (Ctrl+S / Ctrl+Shift+E)
- [ ] 快捷键设置 UI:
  - [ ] 快捷键列表面板
  - [ ] 快捷键搜索与过滤
  - [ ] 快捷键编辑（点击录入）
  - [ ] 重置为默认
  - [ ] 导入/导出快捷键配置

### 验收标准

- ✓ 输入延迟 < 12ms
- ✓ 8K 画布流畅操作
- ✓ 专业级颜色混合效果
- ✓ 快捷键可自定义且无冲突

---

## M7: UI 框架 (UI Framework)

**目标**: 实现专业级可定制 UI 布局系统

### 任务清单

#### 7.1 悬浮面板系统 ✅ 已完成

- [x] 悬浮面板基础组件:
  - [x] 可拖拽标题栏
  - [x] 最小化/最大化/关闭按钮
  - [x] 面板尺寸调节（拖拽边缘）
  - [x] 面板层级管理（z-index）
- [x] 面板状态管理:
  - [x] 面板位置/尺寸持久化
  - [x] 面板可见性状态
  - [x] 面板折叠/展开

#### 7.2 Docking 系统

- [ ] Dock 容器:
  - [ ] 左/右/上/下停靠区域
  - [ ] 中央工作区（画布）
- [ ] Dock 交互:
  - [ ] 拖拽面板到停靠区预览
  - [ ] 停靠位置高亮指示
  - [ ] 面板分组（Tab 形式）
- [ ] 布局分割:
  - [ ] 水平/垂直分割
  - [ ] 分割比例拖拽调节
  - [ ] 嵌套分割支持

#### 7.3 布局管理

- [ ] 预设布局:
  - [ ] 默认布局
  - [ ] 绘画布局（最大化画布）
  - [ ] 参考布局（侧边参考图）
- [ ] 自定义布局:
  - [ ] 保存当前布局
  - [ ] 加载已保存布局
  - [ ] 重置为默认布局
- [ ] 工作区切换:
  - [ ] 布局切换快捷键
  - [ ] 布局选择菜单

#### 7.4 响应式适配

- [ ] 窗口尺寸变化处理
- [ ] 面板最小尺寸约束
- [ ] 小屏幕自动折叠侧边栏

### 验收标准

- ✓ 面板可自由拖拽和停靠
- ✓ 支持 Tab 分组和分割布局
- ✓ 布局状态可保存和恢复
- ✓ 窗口调整时布局自适应

---

## 技术债务与持续改进

### 代码质量

- [ ] 补充单元测试覆盖率到 80%
- [ ] 添加集成测试
- [x] 性能基准测试系统 - 详见 `docs/design/done/benchmark-plan.md`
  - [x] LatencyProfiler (分段剖析)
  - [x] FPSCounter + LagometerMonitor
  - [x] GPU Timestamp Query
  - [x] BenchmarkRunner 自动化
- [x] 视觉一致性测试 - 详见 `tests/visual/gpu-cpu-comparison.html`
- [ ] 修复 Clippy 警告

### 文档

- [ ] API 文档
- [ ] 用户使用指南
- [ ] 贡献者指南

### CI/CD

- [ ] 自动化测试流水线
- [ ] 自动构建发布包
- [ ] 版本号管理

---

## 开发优先级建议

### 第一阶段：最小可用产品 (MVP) ✅ 已完成

0. **M0: 数位板输入** - ✅ WinTab 原生支持已实现
1. **M1: 基础绘画** - ✅ 核心体验已完成
   - ✅ 笔刷大小快捷键 `[` `]` + Alt 取色 + 橡皮擦
   - ✅ 放大镜工具 (Z键) - Scrubby Zoom 已实现
2. **M2.1-2.2: 基础图层** - ✅ 分层绘画已完成
3. **M3.1-3.2: 基础笔刷** - ✅ Flow/Opacity 三级管线已实现

### 第二阶段：功能完善 🚧 当前阶段

4. **M3.3-3.5: 高级笔刷** - ABR 导入、笔刷预设
5. **M5.1-5.3: 文件保存** - 项目保存/加载
6. **M7.2: Docking 系统** - 专业级面板布局

### 第三阶段：专业化

7. **M4: 选区系统**
8. **M5.4: PSD 支持**
9. **M6: 专业特性** (部分已完成)
10. **M7.3-7.4: 布局管理 + 响应式**

---

## 风险与注意事项

| 风险                  | 影响               | 应对策略                   |
| --------------------- | ------------------ | -------------------------- |
| WebGPU 浏览器兼容性   | 无法使用 GPU 加速  | 保留 Canvas 2D 降级方案    |
| octotablet 设备兼容性 | 部分数位板无法使用 | 保留 PointerEvent 备选方案 |
| PSD 格式复杂性        | 导入导出不完整     | 明确支持范围，渐进式实现   |
| 大画布内存压力        | 内存溢出           | 分块加载 + 内存监控        |

---

## 附录：命名约定

### 文件命名

- 组件: `PascalCase.tsx` (例: `LayerPanel.tsx`)
- 工具函数: `camelCase.ts` (例: `colorUtils.ts`)
- 常量: `UPPER_SNAKE_CASE`
- Rust 模块: `snake_case.rs`

### 分支命名

- 功能: `feature/m1-basic-canvas`
- 修复: `fix/brush-pressure-curve`
- 重构: `refactor/layer-store`

---

_本文档将随项目进展持续更新_
